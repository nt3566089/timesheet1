## CopyActivityReport(CH12654)

複数の連続するコピージョブからなるユーザージョブセッション終了時に、ユーザージョブセッション内でカウントしたトータルメーター、ステープル回数、パンチ回数、サイズ毎のコピーシート数、紙質ごとの使用枚数、用紙カラーごとの使用枚数を印刷する。

### Overview

**<概要>**

1.  UIで行うことは、CopyJob終了時にセッション終了するか?の確認画面を開き、

    -   (終了)が選択されたら、Copy結果のレポート出力。

    -   (継続)が選択されたら、セッションを継続する

店頭に設置したマシンで、店に来たお客さんがコピーを行い、この画面で出力した「Copy結果のレポート」をレジにもっていって、コピー料金の支払いを行う。という使い方を想定しているそうです。詳細はFF参照のこと。

2. PGS2000SGP/PGS2002SGPのみ。

**<関連するDFD>**

-   Copy
    Activity設定についてはToolsで有効無効の設定が可能。Tools設定については16.Tools(集計管理)の項参照。

-   Report Jobについては15.Reportの項参照。

### 動作
**<基本動作>**
 ToolsでCopy ActivityReportがONになっている時

1.  コピージョブ終了時にセッション終了するかの確認画面を開く。   以降「セッション終了確認画面」と呼ぶ。

2.  セッション終了確認画面で、終了するが選択された場合、CopyActivityRerportを出力し、セッション終了確認画面を閉じる。

3.  セッション終了確認画面で、継続するが選択された場合、セッション終了確認画面を閉じる。
**<詳細動作>**

1.  コピージョブ終了時にセッション終了するかの確認画面を開く。

※:実装情報:セッション終了確認画面は、JRMより通知されるSessionStatusEventで制御を行う。

###### リソース

|SessionStatusEvent|動作|備考|
|---|---|---|---|
|Close|セッション終了確認画面を閉じる||
|Open|セッション終了確認画面を閉じる||
|Confirm|セッション終了確認画面を開く||


Confirm→Close、Confirm→Openと変化したタイミングでは、セッション終了確認画面を閉じる。

1.  セッション終了確認画面で、終了するが選択された場合、CopyActivityRerportを出力する。セッション終了確認画面を閉じる。

※:実装情報:CopyActivityRerport=レポートジョブを起動するという事です。画面を閉じるのは上記リソース。

1.  セッション終了確認画面で、継続するが選択された場合、セッション継続を受け付ける\*1。セッション終了確認画面を閉じる。

※:実装情報:セッション終了確認を閉じる制御は、JRMより通知されるSessionStatusEventで制御を行う。

\*1:セッション継続を受け付ける(=SessonNvmを更新する)について

セッションの状態(仮称)はシステムデータに連動している。セッション状態NVMは次の3つ状態からなる。

|値|状態|備考|
|---|---|---|---|
|Close|初期状態||
|Open|セッション中||
|Confirm|終了/継続 決定待ち||


NVMの更新はJRMで行われるが、セッション終了確認画面で「継続する」が選択された(Confirm→Open)時だけ、

UIでこのNvm更新を行わなければならない。

OpenにNVMを更新した後、SessionStatusEvent=Open
が通知され、画面を閉じる。

1.  セッション状態は電源が落とされても保持される。  
    例えば、Confirm状態で電源Off/Onした場合、再度Confirm状態が通知され、セッション終了確認画面が表示される事になる。
表示するタイミングはコピーサービスに入った時。デフォルトがコピーサービスなら立ち上がり後表示される事になる。

1.  コピージョブが複数実行中の場合、最後のコピー終了時点でセッション終了確認画面を表示する。\*3

※\*3実装情報 :
JRM側が制御。最後のコピー終了時点でSessionStatusEventを通知。

1.  セッション終了確認画面とコピー起動が交錯した場合、コピー起動はNGとなる\*4。このとき特にメッセージ表示はせずNG音とする。

※\*4 実装情報 : JRM側が制御。
8.セッション終了確認画面でKey受付
特に制限しない。
ステイタスがConfirm状態の場合、コピーサービスに入った時Confirm画面を表示する。割り込みのコピーでも同じ。
プログラムモードがコピー以外の画面では、リセットキー押下でConfirm画面を消す(ステイタスはそのまま。なのでコピーサービスに入った時再度表示する)。コピー画面では、リセットキー押下されても表示を変えない。
9.セッション「終了する」を選択した場合、ActivitryReportJobを起動するが、何らかの理由でActivitryReportJob起動NGとなった場合、特にメッセージ表示はせずNG音とする。
10.セッションConfirm状態で放置された場合、オートクリアタイマのタイムアップで、「終了する」を選択したのと同等の動作をする。
11.セッション「終了する」を選択した場合、コピープログラミングクリアをする。

**<システムデータ>**

|**項目**|**意味**|**パラメータ/備考**|
|---|---|---|---|
|テリトリ情報|M/Cの出荷先テリトリを指定|FX/PGS2000SGP/PGS2002SGP/AP|
|CopyActivityReport有効無効|Tools参照|Tools参照|
|Session状態|現在のセッションの状態を記憶する|Open/close/confirm|


**<機種固有情報>**

**<制限・注意事項/備考>**
 なし。

**<参考資料>**

-   共通プラットフォームシステム基本仕様書FF編 Copy アクティビティーレポート

-   ReportService共通仕様書 3.6.15 Copy Activity Report

-   システム基本仕様書チェインリンク編

-   

### Appendix (Q&A)

# 本項では、以下の理由から、質疑・背景等を記載します。

レビューの場では、「要求」と「それを実現できるか」という事が対になって話し合われます。

その時話し合われた実現概要や懸念点に対する回答は重要な情報です。

実現概要の話の中にResource(JRMIF/Controllerから取得できる情報)が登場します。

UIが取得できるResourceに変化があると仕様にも影響します。

UI-DFDに書かれているUI機能/UI動作は、要求から発生した「要求仕様」だけではありません。実装上あるいはダイアログ上の制限からなる「実装仕様」も書かれています。

その仕様が、要求仕様としてはここまで求めたかったが、実装上の理由でこのような仕様となった…という経緯を残す事も大切な情報です。また、既存実装の枠組みなので、あえてUI-DFDに記載されていないケースがあります。

**実現方法について、正しくはDFD以降の設計書も参照してください。**

――――――――――――――――――――――――――――――――――――――

Q:ステータスがOpen状態で、Toolsでアクティビティーレポート無効に変更した場合、誰かがSession状態をCloseに変更しなければならないと思うのですが・・・

A:JRM(Cont)側で行われます。UIへはSessionStatusEvent=Closeが通知されます。

 同様に、Confirm状態で、Toolsでアクティビティーレポート無効に変更した場合もSessionStatusEvent=Closeが通知されます。

――――――――――――――――――――――――――――――――――――――

Q:Status=Close状態でCopyJob起動時、Status=Openが通知されますが、どのタイミングでOpenが通知されますか?参考までに教えてください。

A:StartResponseの前後です。検討時点は、前の予定。

――――――――――――――――――――――――――――――――――――――

Q:Status=Confirm状態でActivityReport起動時、Status=Closeが通知されますが、どのタイミングでOpenが通知されますか?参考までに教えてください。

A:StartResponseの前後です。検討時点は、前の予定。

――――――――――――――――――――――――――――――――――――――

Q:↑となると、Report出力終わる前に電源が落とされると、結果的にはレシートに相当する紙が出力されないまま、Status=Closeになると考えられますが問題ないですか?

A:それでよい。

――――――――――――――――――――――――――――――――――――――

Q:↑この間(レポート起動～レポートジョブ終了するまでの間)、コピー起動は制限される。とありますが誰が制限かけますか?またこのときの振る舞いはどのように振舞いますか?

A:JRM(Cont)側で行われます。UIからコピー起動をかけると、Ngが返されます。NG音だけで特にメッセージ表示はしません。

UI
の動きとしては、レポートジョブが生成された時点で、レポートジョブのラン画面を表示しますが、コピーのジョブ起動を行うためには、ラン画面の\[閉じる\]ボタンを押下して、コピー画面を表示し、スタートキーを押下する必要があります。このとき、CopyJob
の起動が拒否され、Invalid音(ピピッ)が鳴動すれば特にステイタスラインにメッセージを表示する必要はありません。

――――――――――――――――――――――――――――――――――――――

Q:ActivityReportJobは、中断/中止することが出来ますか?

A:要求としては中断/中止共に禁止としたかった。実装側の都合(ハードキーを止めたりJobQミニポップアップ制御等、また電源落としたら同じ理由などで)で他のレポートと同様のジョブ制御となりました。

――――――――――――――――――――――――――――――――――――――

Q:
オートクリア処理時(タイマの事でなくてTools抜け時や電源ON後の初期画面表示する為に走る処理)も、SessionStatus=Confirm状態であれば、セッション終了確認画面を表示したいのですが・・・。

となると、通常はコピーサービスに入った時点でセッション終了確認画面を表示した方が良いと思われますが、メニューが開いた時などにも表示されることとなります。FCWは実装の都合上、この方が確実なのでその様にしたいのですが・・

A:よい。

――――――――――――――――――――――――――――――――――――――

Q:Confirm画面で、セッションを終了しようと思って「はい」を押さずに、誤って「いいえ」(継続)を押した場合、次のジョブを起動しない限りセッションをCloseできないみたいですが…

A:それでよい。

――――――――――――――――――――――――――――――――――――――