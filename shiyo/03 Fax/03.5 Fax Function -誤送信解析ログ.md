## 誤同報解析ログ

###### 概要
市場より誤同報トラブル(ユーザーが予期しない複数局に送信される現象)の報告を受けた場合、従来のSysLogや各種レポートで採取可能なデータからだけでは、十分な解析を行うことができない。
そこで、解析に必要な情報が採取できるようなログ 『誤同報解析ログ』 を用意する。
本機能は、CH10896にてDMP5以降に機能を導入し、さらにCH26629にてDMP
XI-1cより機能を変更した。
3.5.1ではDMP5にて導入した機能仕様を、3.5.2ではDMP
XI-1cにて導入した機能仕様を説明する。

###  DMP5導入機能仕様
DMP5～DMP XI-1bの機能仕様について説明する。

#### 目的

市場から「FAX誤同報トラブル」を指摘された場合に、ユーザーがUIから同報指示を行ったかどうかを判断するための手段として提供する。

同報指示か否か、同報確認画面を見ているか、が主な解析ポイントとなる。

#### ログの格納場所

FaxContのが管理するNVMに格納する。

誤同報解析ログには、UIのほかJRM,FaxContの生成したログ情報も含まれるが、この項ではログの採取方法と、UIの生成するログの内容を説明する。

#### ログの採取タイミング

###### 概要

 ログの採取は、各ジョブ単位で実施する。

#### ログの出力

###### 概要

ログ取り出し方法には、次の2つの方法がある。

1.  デバシリからのコマンド指示による取り出し

2.  UI操作+EWS操作による取り出し

##### デバシリからのコマンド指示による取り出し

デバシリからのコマンド指示による取り出しについて、説明する。

デバシリより、"PfShowInfo
9"を指示することで、誤同報解析ログがデバシリに表示される。

(誤同報解析ログは、"PfShowInfo
9"コマンドで排出されるログの一部としてデバシリに出力される)

HDDオプション装着機では、"PfShowInfo
8"コマンドとEWS操作によって、ログをPCに取り込むことも、もちろん可能である。

##### UI操作+EWS操作による取り出し(HDDオプション装着時のみ)

UIのハードキー操作により、PfShowInfo
8コマンドを起動(この操作でHDD上にログが採取される)したうえで、EWS操作によりログをPCに取り込むことが可能である。

誤同報トラブル発生時には、CEがCOにUI操作方法に関する情報を開示し、COにハードキー操作を行ってもらった上で、CEがEWSを操作しログを採取する。

1.  ハードキー操作方法
テンキー\[6\]を3秒以上押下しつづけたまま、\[ストップ\]キーを押下する。
後述する動作条件を満たしていれば、この操作によりM/C内部では次の一連の動作が行われる。その結果、PfShowInfo
8コマンドが実行されたのと同じ結果が得られる。すなわち、HDD上にログが採取される。
   動作1: ジョブ規制ありのKO Toolsモードに遷移する。

動作2: PfShowInfo 8コマンドを実行する。

動作3: ジョブ規制ありのKO Toolsモードを抜け、Normalモードに遷移する。

動作4: 正常動作が行われたことをユーザーにフィードバックする。フィードバックの方法は、次のとおり。       
        HB: LCD画面を10秒間白黒反転させる。

FCW: 正常終了音を鳴動させる。(正常終了音のシステムデータ設定が「なし」=鳴らさないになっていた場合は、正常終了音の鳴動はしない)

1.  動作条件
以下の条件を全て満たした時にのみ、HDD上にログが採取される。

1.  UIが定常状態のであること (節電状態や初期化中ではないこと)

2.  システムのモードがNormalモードであること

3.  ジョブ規制ありのKO Toolsモードへの遷移条件を満たしていること

4.  HDDオプションが装着されていること

5.  HDDオーバーライト中でないこと

#### ログ内容の詳細仕様

###### 概要
ここでは、ログの内容の詳細を定義する。
 本機能は、誤同報の原因モジュール究明のための機能であるため、ログ情報はモジュール構成(UIのアーキテクチャ)に依存する。すなわち、HBモデル、FCWモデルでは、ログの内容に差異がある。

##### HBモデルのログ内容
HBモデルでの誤同報解析ログの詳細は、Appendixを参照のこと。

##### FCWモデルのログ内容

以下、FCWモデルでの誤同報解析ログの詳細について、記述する。

1.  ログに残す項目

|**項目名**|**ログフォーマット<br />(printf()に食わせるフォーマット)**|**残す理由**||
|---|---|---|---|---|
|**①ログ発行元サブ**|**&quot;s&quot;**|そのログを残したサブがどこかを知るため。(自サブが残したログ情報のみを取り出すため)<br />ログの先頭に1Byteの識別子を付加する。<br />HB:Panel='P'、Conv='C'<br />FCW:Server='s'、Client='c' (両方とも小文字)<br />JRM:'J'||
|**②トリガとなったユーザー操作**|スタートキー押下によるFaxRequest|**&quot;H&quot;**|設定局数と合わせて見ることにより、同報Confirm画面によるユーザーの承認行為があったかどうかを判断するため|
||同報Confirm「はい」押下によるFaxRequest|**&quot;C&quot;**|↑|
||その他の手段によるFaxRequest|**&quot;O&quot;**|↑。タイマー起動などによるものも含む(あるか?)|
|**③設定局数**|**&quot;T%3d%&quot;**<br />(最大3桁。0サプレスを行う)|ジョブ起動パラメータとしてJRMに渡された、宛先設定局数を知るため||
|**④宛先の詳細(1つ目の設定宛先から4つ目の設定宛先までのみ)**|(1)ダイヤル種別|フルダイヤル=**&quot;F&quot;**<br />短縮ダイヤル=**&quot;S&quot;**<br />グループダイヤル=**&quot;G&quot;<br />**インターネットファクス=**&quot;I&quot;**|実際にどのような宛先をJRMに渡しているかを知るため。(ワイルドカードなのか?など)|
||(2)電話番号|**&quot;%4s&quot;**<br />(最大4ケタ、下4ケタを採用する..当然0サプレスしない)|↑|
|**⑤ジョブ種別**|未送信文書の再送信|**&quot;R&quot;<br />**(Resend Unsent Documentsの略)|宛先情報がない(設定局数=0)ログが、正常かどうかを判断する。<br />以下の4種類のジョブでは宛先情報が不要であるため、ログ上設定局数は0(&quot;T0&quot;)と残ってしまう。<br /><br /> ・未送信文書の再送信で、宛先変更なしの場合<br /> ・手動送信の場合<br /> ・ポーリング予約<br /> ・親展ポーリング予約<br /><br />&quot;T0&quot;がバグでないかどうかを判断するために、上記4種のジョブ起動であるかどうかをこの項で判断する。|
||手動送信/手動ポーリング/手動受信|**&quot;M&quot;<br />**(Manual XXXの略)||
||ポーリング予約・親展ポーリング予約|**&quot;P&quot;<br />**(Polling Reservationの略)||
||上記以外のジョブ|**&quot;N&quot;<br />**(Normalの略)||
||||※タイムスタンプはログに採取しない。前後の関係はダイヤル情報で把握可能なため。|
||||※JrmResponseでのジョブ起動結果は採取しない。JRM側で残すログによりジョブ生成がされたかどうか把握可能なため。|


1.  ログの文法
規則1: ログの先頭は①で始まり、ログの後端はNULL("\\0")で終わる。
規則2: ②③④⑤間は区切り文字で区切る。区切り文字はカンマ(',')とする。
規則3: 複数項目が繋がる場合は、項目番号の若い順から並べる。
規則4: ④-(1)、④-(2)の間には区切り文字は入れない。設定局数が複数の場合は、各局の間に区切り文字を入れる。

1.  ログの出力サンプル
設計時の参考のために、いくつかのログ出力サンプルを提示する。設計者は参考にされたい。

|**サンプルケース**|**ログ出力**|**ログ上の文字数(=byte数… 実際はNULL文字が後端に付加されるため、+1byteになる)**|
|---|---|---|---|
|単局送信の場合|sH,T1,F0123,N|13|
|同報の場合(最長ケース)|sC,T200,F0120,S0001,G011,S0***,N|32|
|未送信文書の再送信(宛先変更なしケース)|sH,T0,R|7|
|未送信文書の再送信(宛先変更:2局の場合)|sH,T2,F012,S111,R|17|
|手動送信|sH,T0,M|7|
|ポーリング予約|sH,T0,P|7|


1.  データの大きさに関する考察
1回の送信指示あたり最大33byteの領域を必要とする。仮に1kbyteの領域が用意された場合、1024÷33≒31送信指示の保存が可能となる。

###  DMP XI-1c導入機能仕様

DMP XI-1c以降の機能仕様について説明する。

#### 目的

市場から「FAX誤送信トラブル」を指摘された場合に、ユーザー誤操作によるものかを判断するための手段として提供する。

ユーザーが入力した宛先と、最終的に送った宛先が一致しているかどうか、が主な解析ポイントとなる。

#### ログの格納場所

JobLogに格納する。1ジョブあたりのログのサイズは150Byteである。

FF Fax Service「FAXオペミス誤送信解析用UIロギング機能」の項を参照。

#### ログの採取タイミング

ログの採取は、UIによるファクス送信ジョブの開始時に実施する。

#### ログの出力

PA'nDAの障害ログ収集機能、ジョブログ変換機能を用いて取得・表示する。

#### ログ内容の詳細仕様

ここでは、uilcwが保存するログの内容の詳細を定義する。
###### ログの内容

|Index|項目名|Byte数|型|取りうる値|備考|
|---|---|---|---|---|---|---|
|0|サービス種別|1|数値|0x01 ファクス、ファクス/インターネットファクス<br/>0x02 らくらくファクス<br/>0x03 インターネットファクス(MN)<br/>|どこからサービスインしたかを示す。<br/>サービス種別を特定できない場合は、「ファクス」とする。<br/>|
|1|ファクス送信ジョブの種別|1|数値|0x01 ファクス蓄積送信<br/>0x02 未送信文書の再送信<br/>0x03 手動送信<br/>||
|2-3|スタート画面|2|数値|LCW Frame ID<br/>0xFFFF ID取得不可時<br/>|最初にスタート操作をした画面*1|
|4-5|ジョブ起動画面|2|数値|LCW Frame ID<br/>0xFFFF ID取得不可時<br/>|ジョブ起動時の画面*1|
|6|ジョブ起動操作|1|数値|0x01 スタートキー押下<br/>0x02 画面内ボタン押下<br/>|ジョブ起動のトリガとなるユーザー操作*1|
|7|回線番号|1|数値|0 自動<br/>1～ 回線番号指定<br/>|回線番号指定ができない場合は、0(自動)とする。|
|8|宛先指示数|1|数値|1～200<br/>0 宛先指示数不明<br/>||
|9-10|送信宛先数(ファクス/IPファクス)|2|数値|0～|現状ファクス/IPファクスそれぞれの宛先数を取得できないため、ファクス/IPファクスの総数としている。|
|11-12|送信宛先数(インターネットファクス)|2|数値|0～||
|13-149|宛先詳細|||<宛先詳細の内容>を参照。|残りの領域に対して、指示された宛先分を繰り返す。<br/>余白の領域は0で埋める。<br/>宛先詳細が取得できない場合は全て0で埋める。<br/>|

\*1:
スタートキー押下後にConfirm画面が出る場合、スタート画面とジョブ起動画面が異なる。このときのジョブ起動操作は、ジョブ起動画面での操作を指す。  
例1: 基本画面でスタートキーを押下してジョブ起動した場合  
スタート画面=基本画面、ジョブ起動画面=基本画面、ジョブ起動操作=スタートキー押下  
例2:
基本画面でスタートキーを押下後、宛先二度入力画面で「スタート」ボタンを押下してジョブ起動した場合  
スタート画面=基本画面、ジョブ起動画面=宛先二度入力画面、ジョブ起動操作=画面内ボタン押下
各画面における、各項目の設定内容については、「Appendix
Fax誤送信解析ログ-画面毎の情報取得可否一覧」を参照。

###### 宛先詳細の内容

|宛先詳細項目|Byte数|型|とりうる値|備考||
|---|---|---|---|---|---|---|
|宛先種別|1|数値|0x01 フルダイヤル(ファクス)<br/>0x02 フルダイヤル(インターネットファクス)<br/>0x04 フルダイヤル(IPファクス)<br/>0x10 短縮ダイヤル<br/>0x20 グループダイヤル<br/>0x40 仮想短縮ダイヤル<br/>|短縮ダイヤルは、短縮同報を含む。<br/>  ※CH29980 により DMP-XI-8a/DMP-XIII-1a以降、仮想短縮機能はサポート対象外。<br/>||
|宛先|フルダイヤル|1～128|文字列|フルダイヤル文字列|チェーンダイヤルは展開済みの番号をフルダイヤルとして保存する。|
|||1||0|可変長であるフルダイヤル文字列の終端を示す。|
||短縮ダイヤル|4|文字列|短縮ダイヤル文字列|PCCFax(短縮3桁)の場合も4桁固定とする。<br/>ワイルドカード指定は展開せずそのまま保存する。<br/>|
||グループダイヤル|1|数値|1～50||
||仮想短縮ダイヤル|4|数値|1～999999|  ※CH29980 により DMP-XI-8a/DMP-XIII-1a以降、仮想短縮機能はサポート対象外。|

###### 2Byte以上の数値型データの扱い
上位Byteから順に1Byteずつ配列に格納する。
###### 150Byteを超えるデータの扱い
150Byteを超えるデータの場合は、150Byteでデータを切る。
ただし、150Byte目が宛先種別、フルダイヤル文字、フルダイヤル区切り文字となるケースでは、150Byte目に0x7Fをセットする。