## Software Download

### Software Download (DLD方式)
###### 概要
クライアントPCまたはPSWを用いて実施されるSoftware
Download(DLD方式)について記述する。
Download中であることを、LCDに表示する。(備考参照)
Downloadの実行状態を、蓄積LEDと通信LEDを用いて表示する。(備考参照)
###### Download起動オペレーション
節電ボタンを押下しながら電源スイッチをONする。
###### Software Download実行時のMC状態
LCDにDownload専用画面を表示し、全てのKeyの受付を禁止する。
Download実行状態は、蓄積LEDと通信LEDを点灯、点滅および消灯する事で表す。
###### Software Download終了時の動作
Downloadが終了すると、自動的に初期化処理(Power On
Sequence)が走り、Customer Modeに戻る。
###### 制限・注意事項/備考

-   PSW直付けによるDownloadとNet経由のDown Loadがある。

-   NetでのDownloadに用いるIPアドレスの設定方法は
    > 「通常のアイドル画面でDownload用IPアドレス(通常のIPアドレスと同じになる場合もある)を設定して、その値をDownload時にDownloadプログラムが読込む」。

-   -   Downloadの起動から終了までの各種制御は、Download専用モジュールが行う。通常のUIモジュールは一切処理しない。  
    > <Imari>は、UIがコントローラとは別CPUで、DownloadモジュールもUI用がコントローラ用とは別に在り、LCD制御はUIが、LED制御はコントローラが行う。  
    > <PGS7018SGP&gt;&lt;Kutani>以降は、UIはコントローラと同一CPUで、UI専用Downloadモジュールは無く、LCD/LED制御は共にコントローラのDownloadモジュールが行う。
###### 参考資料
Common Features&Functions(Ⅲ:Management Service)編
Ⅲ.Ⅴ:Installation Management
Ⅲ.Ⅴ.Ⅲ:Download

### Software Download (PJLジョブ方式)
###### 概要
デバイスがノーマルモードの状態でダウンロードを行う機能(以下、PJLジョブ方式)について記述する。
ダウンロード中であることを、UIに表示する。
###### 動作条件
PJLジョブ方式は、プリンタ機能を搭載する機種、またはコンフィグレーションに対応する。
プリントジョブが受信、実行できる状態であること。
ダウンロードを許可するシステムデータが許可に設定されていること。
ジョブが実行中でないこと。
ユーザー操作中でないこと。
###### 動作
デバイスが外部からのダウンロードデータを受信し、上記動作条件やダウンロードデータのチェックなどを行い、問題なければデバイスはダウンロードモードに移行する。
MaintenanceJobのFirmwareDownload
開始通知により、UIはダウンロード画面を表示する。
ダウンロードが終了しても、ダウンロード画面は閉じない。
ダウンロードが正常終了すると、デバイスは自動的にリブートする。
ダウンロードが異常終了したときは、ダウンロード画面に異常終了の表示を行う。 エラーコード(xxx-xxx)の表示を行う。 (CH15542)
ダウンロードデータ書き込み中に、電源オフなどで書き込みが完了できなかった場合、デバイスは次の電源立ち上げ時に強制的にダウンロードモードへ移行する。(節電ボタン押下なしで)
###### システムデータ

|項目|設定|設定範囲|デフォルト値|備考 |
|---|---|---|---|---|---|
|Download Service|KO|Enable (=0)<br/>Disable (=1)<br/>|Enable|(Chain-Link : 700-042)|

###### 制限・注意事項/備考
サポートユーティリティ、プロトコル:
PGS0101SGP Download Utility
PGS1028SGP (PGS1002SGP, AP向け) (CH12847)
lpr、 HTTP File upload、 など
###### 参考資料
FF: 「3-2-5-3 FF Download(K1.7.4).doc」
外部仕様書: 「PGS1028SGP 外部仕様書(K1.0R4)」

###  リモートダウンロード (DMP2009-1以降) (CH16386)
###### 概要
次世代EPシステム(WEP)の運用で、FW更新作業を簡素化することを目的として、従来FW更新作業時に必要であったPCおよびUSBメモリを必要としない機能である。
ネットワークに接続されたサーバーからFW更新ファイルを取得し、デバイス内のHDDに格納後、自動的にダウンロードモードに遷移し、FWのアップデートを実施する。
###### 動作条件
HDDあるいはSD
Cardが搭載されている。(CH36265でSdCard搭載を追加)
WEP(EP-BB)が設置済み。
ソフトウェア更新機能(KO或はCE)が有効である(下記のシステムデータを参照)。
###### 動作

1.  ファームウェアバージョン情報取得  
    ① KOまたはCEは、UIから「ファームウェアバージョン取得」を指示する。  
    ② (CH22751により追加:DMP-X-PL2以降) CEの場合は、その際に

    1.  更新時、NVM書き換え等の付随処理もすべて自動で実施するモード(KOからの更新指示と同等の動作をするモード)

    2.  ファームウェアのダウンロードと更新のみを実施するモード(通常のCE用動作モード)
のいずれかを選択する。
③
デバイスはサーバーにバージョン情報の問い合わせを行い、UIはバージョンの確認を実行中であることを表示する。  
④
サーバーから返されたバージョン情報の問い合わせ結果をUIに表示する。  
- ソフトウェアアップデート可能なソフトウェアバージョンが確認できた場合、バージョンが確認できたことをUIに表示し、バージョンアップ実行ボタンを表示する。  
CEの場合は、更新可能なソフトウェアバージョンをUIに表示する。  
- 最新バージョンであった場合、デバイスは最新バージョンになっていることを表示する。(Chain-Link:未定)  
- エラーが通知された場合、UIにエラーに対応したフォルトコードを表示する。(Chain-Link:未定)

-   CH22751に関する補足:
②で選択するモードにより、バージョン取得～ダウンロードまでの内部的な動作が異なるため、操作フロー上、CE時のモード選択はバージョン取得よりも先である必要がある。

1.  ファームウェア更新  
    ① KOまたはCEは、UIから「ファームウェア更新指示」を指示する。  
    ②デバイスは、ファームウェア更新ファイルとChain-Link更新ファイル(必要により)をダウンロードする。  
      UIは更新ファイルのダウンロードの状況を表示する。  
      UIからダウンロードの中止を指示できる。  
    ③
    UIからダウンロードの中止を指示した場合、UIに中止中を表示し、中止処理の完了が通知されたら、UIに中止した旨を表示する。  
    ④
    ダウンロードでエラーが通知されたら、UIにエラーに対応したフォルトコードを表示する。  
    ⑤
    ダウンロードが正常に完了したら、画面は100%の状態表示のまま、ユーザー操作を受け付けない。

2.  再起動
①
デバイスはファームウェア更新ファイルとChain-Link更新ファイルのダウンロードが正常に終了したら、EPセンターにファームウェア更新の開始を通知し、  
通知が完了したら、デバイスを再起動する。  
再起動するまでUIはダウンロード完了の100%状態表示のまま。
###### システムデータ

|項目|設定|設定範囲|デフォルト値|備考 |
|---|---|---|---|---|---|
|ソフトウェア更新機能(KO用)の有効/無効|CE|True : 有効<br/>False : 無効<br/>|False|(Chain-Link : 920-053)|
|ソフトウェア更新機能(CE用)の有効/無効|CE|True : 有効<br/>False : 無効<br/>|False|(Chain-Link : 920-054)|

###### 制限・注意事項/備考
対象機種: DMP2009-1以降の機種共通。(CH16386)
###### 参考資料
FF: 「3-2-5-3 FF Download(K1.11.0)Draft0.doc」
「WEP FF (Common)K1.6.0.doc」

### 日時指定ダウンロード (DMP-X2以降) CH22159,CH22461
###### 概要
21.5.3 リモートダウンロード
に記載のファームウェアダウンロード～更新の機能を、日時を指定して実施できるようにする。
これにより、M/Cが使用されていない夜間等の時間に自動的にファームウェア更新を実施できるようになる。
###### 動作条件
HDDあるいはSD
Cardが搭載されている。(CH36265でSdCard搭載を追加)
WEP(EP-BB)が設置済み。
ソフトウェア更新機能(KO)が有効である(下記のシステムデータを参照)。
日時指定ソフトウェア更新機能が有効である(下記のシステムデータを参照)。
###### 動作

1.  更新日時の予約
21.5.3 リモートダウンロード 2.ファームウェア更新
に記載のあるファームウェア更新指示のタイミングで、ユーザがKOである場合には
- その場で即時ファームウェア更新
- 日時を指定してファームウェア更新の予約
のいずれかを選択する。
その場で即時ファームウェア更新を選択した場合は、21.5.3
リモートダウンロード 記載の処理が続行される。
日時を指定してファームウェア更新
を選択した場合は、日時を指定するための画面に遷移する。
ユーザがCEであった場合、日時指定はできないので 21.5.3
リモートダウンロード と同様の動作をする。
すでに別の日時が設定されていた場合には、別の日時を指定することができる。(その場で即時更新はできない。)
日時を指定するための画面では、以下の指定ができる。
- 日時指定をする/しない
- 日時指定をする場合には、指定する 月/日/時/分
すでに日時指定がされているときに日時指定を「しない」にすることは、アップデート予約のキャンセルとして働く。
指定できる日時の範囲は、10分後～8日後。ただし、最大値についてはシステムデータにて1日～30日の範囲で変更可能である。(CH22461)
※設定できる最大が30日後であることから日時指定について「年」を入力させる必要はないため、ダイアログ仕様では「年」の入力は省かれている。

1.  予約日時の表示
予約日時が設定されている場合、その日時をCOに知らしめるため、以下により更新が予約されている旨と、その日時を表示する。
- 機械確認 > ソフトウェアバージョン 画面
予約日時が設定されているときには常に、本画面で更新予約がされている旨とその日時を表示する。
- ステータスメッセージ (ブロードキャストメッセージ)
予約日時の24時間前以降については、ブロードキャストメッセージとして更新予約がされている旨とその日時を表示する。
表示タイミングは、オートクリアのタイミングとする。

(サービスインでも表示させるようにすると、消耗品関連メッセージを表示するタイミングがなくなってしまうため。)
予約日時の設定や変更は、UIからだけでなくPGS1028SGPやEPBBセンターからも実施される。
変更は随時Controller側から通知されるため、UI表示はそれに追従する。

1.  自動更新時の画面ロック
設定した予約日時が到来し、M/Cがダウンロード～ソフトウェア更新が可能な状態にある場合にはダウンロードが開始される。
その際、UIはダウンロード中である旨を表示して画面をロックする。
UIに対するパネルタッチおよびハードキー入力は受け付けない。

1.  更新結果の表示
ソフトウェア更新実施後の再起動時に、日時指定をした設定元とソフトウェア更新結果により、下記のとおり結果の表示をPopupにて行う。

|設定元|成功時|失敗時|
|---|---|---|---|
|オンサイト(UI/PGS1028SGPから)の日時指定|成功した旨を表示する|失敗した旨とエラーコード(Chain-Link番号)を表示する|
|リモート(EPBBセンター)からの日時指定|表示しない|表示しない|

再起動時に、この他に表示すべき特別な画面 (InstallWizard等)
がある場合には、本画面が閉じられた後に表示する。

1.  アップデート中の表示 (LCW-UIソフトウェアは関与しないため 参考情報)
OS/Downloaderが表示するダウンロード中の画面について、リモートからのダウンロード時には
- 電源を切らないよう注意を促す文言のIBG向け6カ国語による表示
を追加する。
###### システムデータ

|項目|設定|設定範囲|デフォルト値|備考 |
|---|---|---|---|---|---|
|日時指定FWアップデート可否|CE|0:不可<br/>1:可<br/>|不可|(Chain-Link : 920-75)|
|ソフトウェア更新機能(KO用)の有効/無効|CE|0:無効<br/>1:有効<br/>|無効|(Chain-Link : 920-53)|
|予約指示ユーザ情報|自動|0:未設定<br/>1:KOによる即時更新<br/>2:CEによる即時更新<br/>3:リモートによる日時指定<br/>4:オンサイトKO日時指定<br/>|未設定|(Chain-Link : 791-21)|
|FWアップデート結果|自動|0:未設定<br/>1:成功<br/>2:失敗<br/>|未設定|(Chain-Link : 791-22)|
|FWアップデート失敗時のFailCode|自動|Integer<br/>上位2byte:Chain<br/>下位2byte:Link<br/>|0|(Chain-Link : 791-23)|
|指定可能な日時の上限|CE|1～30|8|(Chain-Link : 920-79)|


※設定欄の「自動」は、本システムデータがJRM等より自動的に設定されるものであり、KO/CEにより設定されるものではないことを意味する。

###### 補足
予約日時が到来したときにユーザ操作中等によりアップデート開始ができない(Tools
Entryできない)場合は、自動的にリトライが実施される。
リトライ中は、Tools画面内のソフトウェアバージョンアップ画面に入ることはできない。
本機能にて表示される予約日時の表示フォーマットについては、既存システムデータ
- 年月日時刻順序フォーマット (700-122)
- 時刻表示切り替え (700-123)
に従う。

### ソフトウェアバージョンアップ (DMP-XI-4a以降) CH33789、CH35028
###### 概要
21.5.3 リモートダウンロード
に記載のファームウェアのダウンロード機能とファームウェア更新の機能を別々に実施できるようにする。
M/Cが使用されていない夜間等の時間に自動的にファームウェアのダウンロードのみをバッググラウンドで実施する。
CEの操作により実施されるファームウェアの更新時には、ファームウェアのダウンロードの待ち時間が不要となる。
###### 動作条件
HDDが搭載されている。
WEP(EP-BB)が設置済み。
ソフトウェア更新(CE)フラグ(920-054)が有効である(下記の<システムデータ(既存)>を参照)。
バックグラウンドダウンロードフラグ(920-178)が有効である(下記の<システムデータ(新規)>を参照)。
###### 動作

1.  ファームウェアのバックグラウンドダウンロードの設定
NVM
Read/Write画面(Chain-Linkアクセス)にて、下記のシステムデータを設定することができる(下記の<システムデータ(新規)>を参照)。
- バックグラウンドダウンロード周期(Chain-Link : 920-174)
- バックグラウンドダウンロード時刻(時) (Chain-Link : 920-175)
- バックグラウンドダウンロード時刻(分) (Chain-Link : 920-176)
- バックグラウンドダウンロードフラグ(Chain-Link : 920-178)

1.  ファームウェアのバックグラウンドダウンロード時の表示
ファームウェアのバックグラウンドダウンロードが実施されている時、UI画面には何も表示されない。

1.  ファームウェアのバックグラウンドダウンロードのキャンセル
ファームウェアのバックグラウンドダウンロードをユーザが直接キャンセルすることはできない。
ただし、21.5.3
リモートダウンロードにて即時更新を指示した場合、ファームウェアのバックグラウンドダウンロードは中止される。

1.  ファームウェアの更新方法の提示
ファームウェアのバックグラウンドダウンロードが完了していることは、ダウンロード済みファームウェアのバイト数(Chain-Link
: 920-177)が0でないことで判断する。
(下記<システムデータ(新規)>参照)。
ダウンロード済みファームウェアのバイト数が0でない場合、バージョンアップのボタンを表示する。
ダウンロード済みファームウェアのバイト数が0である場合、バージョンアップのボタンを消去する。

1.  ファームウェアのバージョン確認
バージョンアップのボタンを押下することにより、ファームウェアのバージョンを確認する。この時、バージョン確認中の画面を表示する。
デバイスに適用可能なファームウェアであれば、バージョンアップ確認画面を表示する。
デバイスに適用可能なファームウェアでなければ、バージョンアップできないこと及びダウンロードされているファームウェアを削除する旨を表示する。

1.  ファームウェアの更新
バージョンアップ確認画面にて、更新ボタンを押下したら、ファームウェアの更新を実施する。
UIに対するパネルタッチおよびハードキー入力は受け付けない。

1.  ファームウェアのダウンロード(LCW-UIソフトウェアは関与しないため
    参考情報)
バックグラウンドダウンロード周期/時刻(時)/時刻(分)により、ファームウェアのバックグラウンドダウンロードの処理が実行される。
###### システムデータ(新規)

|項目|設定|設定範囲|デフォルト値|備考 |
|---|---|---|---|---|---|
|バックグラウンドダウンロード周期|CE|50   : 1回/週(日曜)<br />51   : 1回/週(月曜)<br />52   : 1回/週(火曜)<br />53   : 1回/週(水曜)<br />54   : 1回/週(木曜)<br />55   : 1回/週(金曜)<br />56   : 1回/週(土曜)|50  : 1回/週(日曜)|(Chain-Link : 920-174) CH33789, CH35028<br/>※NVM Read/Writeのみ提供する<br/>|
|バックグラウンドダウンロード時刻(時)|CE|0～23(時)|0|(Chain-Link : 920-175) CH33789<br/>※NVM Read/Writeのみ提供する<br/>|
|バックグラウンドダウンロード時刻(分)|CE|0～59(分)|0|(Chain-Link : 920-176) CH33789<br/>※NVM Read/Writeのみ提供する<br/>|
|ダウンロード済みファームウェアのバイト数|-|0～4294967295(バイト)|0|(Chain-Link : 920-177) CH33789|
|バックグラウンドダウンロードフラグ|CE|0 : 無効<br/>1 : 有効<br/>|0 : 無効|(Chain-Link :  920-178) CH35028<br/>※NVM Read/Writeのみ提供する<br/>|

###### システムデータ(既存)

|項目|設定|設定範囲|デフォルト値|備考 |
|---|---|---|---|---|---|
|ソフトウェア更新機能(CE用)の有効/無効|CE|True : 有効<br/>False : 無効<br/>|False|(Chain-Link : 920-054)|
