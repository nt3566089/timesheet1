## Media Popup

### Media Popup

###### 概要

トレイが操作されたタイミングで、該当トレイの詳細設定画面(Media
Popup画面)を表示し、ユーザーによる変更を可能にする。

DedicatedTray指定されていた場合には上記ユーザ変更を禁止し、詳細確認表示を行う。この際、トレイの用紙設定と実際にセットされた用紙が異なっている場合(SizeError検知時)にはエラー表示を行う(DMP2009-2より、CH16074により導入)。

PDI (COML\_PDI\_TRAY\_SETTING\_WHILE\_RUN)
の設定が「有効」の場合(以降Run中の設定変更可)は、RUN中に未使用トレイの設定変更を可能にする。(CH25405)

変更可能な項目はToolsのトレイ設定と同様。

各項目の表示/設定可能条件など、詳細は、16.3.2.2 Tools Common
トレイ設定を参照。

###### 動作内容

   <MediaPopup表示タイミング>

        ・DMP-XI-1bまで:

トレイをセットしたタイミング(※ \[トレイ抜け\]の状態から、\[トレイがセットされた\]
状態に遷移した時)

 ・DMP-XI-1c以降:

PDI (COML\_PDI\_MEDIA\_POPUP\_TIMING) で指定されたタイミング。

  - トレイをセットしたタイミング

  - トレイを抜いたタイミング

 ただし、SMH/Interposerは常にトレイをセットしたタイミング

    
以下、トレイ操作とはMediaPopup表示タイミングとなる操作のことを示すこととする。

###### 表示条件

1.  システムデータ\[用紙種類の変更画面表示\]が\[する\]に設定されている。

    -   CH8438により導入。仕様設定/登録変更から設定可能。
②PrintAroundジョブがフォアグラウンド表示中。

-   CH14899により導入。
③DedicatedTray指定されたトレイがSizeError状態となっている。

-   CH16074により導入。


-   ①,②のいずれかを満たし、トレイを操作したとき。

-   ③を検知した時。

-   ③のトレイが\[トレイ抜け\]を検知した時。

-   ③が存在する状態でAutoClear動作時。

-   以上のタイミングで以下の禁止条件に該当しない場合、MediaPopup画面を表示する。
MediaPopup表示禁止条件:

|PrintAround対象外機種|
|---|---|
|ForegroundJob表示中<br/>JAM画面が表示中<br/>Tools Mode中<br/>Diag Mode中<br/>Low Power<br/>Sleep / 初期化中<br/>割り込み中(CH13723)<br/>|

例外条件:
- ForegroundJob表示中

-   PrintAround対象機種の場合は、禁止条件から「Held-PrintAroundの時」を除く

-   Run中に未使用のトレイ設定変更可能時(PDI)は、「ForegroundJob表示中」ではなく、「ジョブのフォルト画面を表示中」はMediaPopupを表示しない、とする(CH25405)
- LowPower

-   復帰時に禁止条件に該当しなければ表示する (CH10154)
- 割り込み中

-   PrintAround対象機種の場合は表示する。

-   Run中に未使用のトレイ設定変更可能時(PDI)は表示する(CH25405)
  
- 
 Run中の設定変更可の場合は、Run画面表示中も、トレイ操作でMediaPopupを表示する。この時、トレイ操作時点でトレイの状態を設定中に変更可能かどうかは条件としない(CH25405以降)。

-   あるトレイのMediaPopup表示中に他のトレイを操作した場合、表示中のMediaPopupではパラメータを保持し子画面を全て閉じた上で、操作したトレイのMediaPopup画面表示を行う。

-   MediaPopup表示中のトレイを再度操作した場合は、画面をそのまま維持し何もしない。ただし、トレイの再セットによりDedicatedTray指定トレイのSizeError状態が変化した場合(非SizeError⇔SizeError)にはMediaPopup動作を行う(CH16074)。

###### 消去条件

-   "決定"押下し、設定変更が正常に受付られた時

-   "取り消し"押下時

-   "閉じる"押下時(CH16074により追加)

-   画面再構築を伴うオートクリア等の動作

    -   オートクリア、割り込みEntry時、Exit時、ショートカットキー、メニュキーによる画面遷移時。ただし、オートクリア時はDedicated指定かつSizeErrorのトレイは再表示される。

-   複数のトレイ操作をPGS1318SGP遷移前後で実施した場合、PGS1318SGP遷移前のMediaPopupは消去される。(HBのみ)

-   Menu方式で
    JobStatus/MCStatusから別PGS1318SGPに遷移するとき、JobStatus/MCStatus画面上のMediaPopupは消去される。(FCWのみ)

###### 表示内容

-   表示する内容についてトレイの状態により以下の制限を持つ。
\[DedicatedTray指定なし\]の場合、トレイにセットされている用紙サイズを表示する。

-   IOT State : Lift UP
    → 用紙サイズ自動検知の場合、この時点ではサイズ不定(ブランク)

-   IOT State : Ready / No Paper → 用紙サイズを表示
\[DedicatedTray指定あり\]の場合、トレイ詳細設定で指定された用紙サイズを表示する。

-   IOT State : SizeError発生中
    → トレイに設定された用紙属性と実際にセットされている用紙が異なっていることを示す。

-   IOT State : SizeError解除後
    → MediaPopupでは設定が変更できず、確認のみ可能な旨を表示。

###### トレイ詳細設定動作

-   トレイ詳細設定はトレイ設定画面の\[設定変更\]ボタン操作により行うことができるが、以下の場合には設定変更は禁止される。

    -   DedicatedTray指定されているトレイ
\[設定変更\]ボタンは非表示となる。この際、トレイの用紙設定と実際にセットされた用紙が異なっている場合(SizeError検知時)にはエラー表示を行う(DMP2009-2より、CH16074により導入)。

-   Run中の設定変更可の場合
\[設定変更\]ボタン押下時、
IOTscに「設定中」状態に遷移することを通知しNGの場合はトレイ設定編集画面に遷移しない。OKの場合のみ設定変更が許可され、トレイ設定編集画面に遷移する。(CH25405以降)

-   各トレイの詳細パラメータ更新は、トレイ設定画面(Media
    Popup時に最初に表示される画面)を閉じるタイミングで一括して行われる。

-   Run中の設定変更可ではない場合(CH25405以降)、詳細パラメータ更新はToolsMode(ジョブ規制有り)に遷移し、システムデータの更新を行うことで実現されるが、PrintAround対象機種(Level1)では以下の条件でToolsModeへと遷移しない(RF2225/CH15126)。

|更新内容詳細|ToolsMode遷移の有無|
|---|---|---|
|サイズ変更なし|なし|
|定型サイズ→定型サイズ||
|定型サイズ→非定型サイズ|あり|
|非定型サイズ→定型サイズ||
|非定型サイズ→非定型サイズ||


-   Run中の設定変更可の場合、トレイ詳細設定操作を終了する際、以下の制御を伴う。

    -   設定を更新して終了する場合
Trayの情報を更新後、IOTscの\[設定中\]状態に対し、\[終了\]通知し、非設定中状態に変更する。

-   設定を更新せずに終了する場合
IOTscの\[設定中\]状態に対し、\[取消し\]通知し、非設定中状態に変更する。
この際、終了のさせ方によらずToolsMode状態の変更(Entry/Exitのいずれの操作も)は行わない。(CH25405以降)

-   Print
    Around対象機種(Level1)の場合、以下のケースでは設定変更を受け付けない。(RF2225)
    (DMP-Yokohama-2cまで、DMP-Kobe以降は許可する。)

    -   結合ジョブがIIT占有中

###### MediaPopup中のIOTスケジュール禁止動作(CH17075により導入)

-   用紙トレイの状態変化やMediaPopup表示状態の変化に伴い、システムデータ\[PFRID\_IOT\_INTRAY\_USER\_OPERATION\_STATUS\]の該当トレイの状態を以下のように制御する。

    -   \[トレイ抜き\]検知時、もしくはMediaPopup表示時(※1、※2)、該当トレイの状態を操作中(1)に設定する。

    -   非\[トレイ抜き\]状態且つMediaPopup非表示状態が成立時、該当トレイの状態を非操作中(0)に設定する。
※1 Tray挿入時以外のMediaPopup表示条件も含む。
※2
MediaPopup表示はLowPower中の表示予約状態を含む。LowPower復帰後MediaPopup禁止状態の場合、その時点でMediaPopup非表示状態となる。

☆SMHの制御に関してはSMH Media Popupの章で説明する。

###### 制限・注意事項/備考

-   Media
    Popup画面がフォアグラウンド表示状態では、\[スタート\]、\[リセット\]
    キーは禁止。それ以外のボタン/キー操作に対する制限はない。

-   Media Popup画面を表示したタイミングでは、Tools Modeに遷移しない。

-   Media Popup画面を閉じるタイミングで詳細パラメータを変更する場合、IOT
    Lib.を用いて設定チェックを行う必要がある。「16.3.2.2.13.
    用紙の穴あき属性」参照。

-   複数のトレイに対して操作を行った場合、最後に操作したトレイ画面を最上位に表示する。

-   画面動作に関する詳細は、Dialog仕様書を参照

-   CH10154は、DMP5以降のMN
    Productが対象として導入したが、特に仕向け地での制限をかけずに提供している(HB/FCW共通)
    。

-   あるジョブにおいて、用紙トレイが設定中でプリントを実行または継続できない場合、その用紙トレイの設定完了待ちのOperational
    Errorになる。(CH25405以降)

-   

###### 参考資料

### SMH Media Popup

###### 概要

SMHに用紙をセットされたタイミングで、SMH Media Popupが有効な場合にSMH
Media Popup画面を表示する。

このときSMH用紙幅ガイドからその長さに適合する用紙サイズを自動的に決定する。

その後、このガイド位置変更を一定周期で監視しリアルタイムに適合する用紙サイズを自動的に表示変更する。

なお、SMH Media Popupが有効でない場合は、従来のLast Tray
Insert動作と同様。

###### 動作条件

-   SMH Media Popupが、有効であること
\[有効判断\]
～DMP4 :NVM切り替え
DMP5～DMP-X-PL2 / DMP-X2 (\*DMP2009-4b-PLは除く)
:PDILibの呼び出し(CH10574対応によりNVM(CE設定)→PDILibの結果へ変更)
DMP2009-4b-PL, DMP-XI～
:NVM切り替え(CH22696対応によりNVM(780-278)へ変更)

-   ((※)

    -   例外としてPrintAroundジョブがフォアグラウンド表示されている、PrintAroundジョブがフォアグラウンド表示中にPopupしたMediaPopupが表示されており、そのジョブがPrintAround中である場合はこれにSMH
        Media
        Popupの有効/無効の結果に従わず表示する(<CH15614>DMP-Kobe1以降共通)。

-   従来の内蔵トレイMedia Popup有効/無効(KO設定)と、上記SMH Media
    Popup有効/無効結果におけるSMHのユーザ操作表示は以下となる。

||SMH Media Popup**有効**|SMH Media Popup**無効**|||
|---|---|---|---|---|---|
|ユーザー操作|内蔵トレイMedia Popup **有効**|内蔵トレイMedia Popup **無効**|内蔵トレイMedia Popup<br/>**有効**<br/>|内蔵トレイMedia Popup<br/>**無効**<br/>|
|手差しトレイ<br/>(用紙挿入)<br/>|**SMH Media Popupを表示する**|従来通りLast Tray Insert<br/>SMH画面を表示する<br/>|||
|手差しトレイ<br/>(Copy手差しトレイボタン選択)<br/>|(Popup Openしない)|従来通りSMH Popup画面表示|||
|内蔵トレイ<br/>(トレイ挿入)<br/>|従来通り(内蔵トレイMedia Popup Open)|(Popup Openしない)|従来通り(内蔵トレイMedia Popup Open)|(Popup Openしない)|
|内蔵トレイ<br/>(Copy内蔵トレイボタン選択)<br/>|||||

SMH MediaPopup表示禁止条件:

|PrintAround対象外機種|
|---|---|
|ForegroundJob表示中<br/>JAM画面が表示中<br/>Tools Mode中<br/>Diag Mode中<br/>Low Power<br/>Sleep / 初期化中<br/>割り込み中<br/>|

例外条件:
- ForegroundJob表示中

-   Print Around対象機種(PDI Lib.)では、表示中のForegroundJobが「Print
    Around専用Fault画面」の場合は表示する(RF2225)

-   ジョブ中のSMH設定変更が許可(PDI-Libで判断)のプロダクトでは、IITを占有している結合ジョブがフォアグランド表示中は表示可能(CH13723)

-   Run中設定変更可の時(PDI)は、「ForegroundJob表示中」ではなく、「ジョブのフォルト画面を表示中」はMediaPopup画面を表示しない、とする。(CH25405以降)
- LowPower

-   復帰時に禁止条件に該当しなければ表示する (CH10154)
- 割り込み中

-   Print Around対象機種(PDI Lib.)では表示する(RF2225)

-   ジョブ中のSMH設定変更が許可(PDI-Libで判断)のプロダクトでは表示する(CH13723)

-   割り込み中に手差しトレイの用紙情報変更機能が有効時(780-387:1)は表示する。(CH27057)(\*)本機能設定はPinot-ILとProseccoのみ可

-   Run中に未使用のトレイ設定変更可能時(PDI)は表示する(CH25405)

###### 動作内容

-   画面を表示するタイミングは、SMH Nopaperの状態から、SMH
    Ready状態(用紙セット)に遷移したタイミング。

    -   Power ON時
表示しない

-   Low Powerからの復帰時

|Low Power前|Low Power後|Low Power中の<br/>操作<br/>|画面表示|備考|
|---|---|---|---|---|---|
|紙なし|紙なし|操作なし|非表示||
|||抜差し|表示する||
||紙あり|任意|表示する||
|紙あり|紙なし|抜きのみ|非表示||
|||抜差し|表示する||
||紙あり|操作無し|非表示||
|||抜差し|表示する||


-   Sleep Modeからの復帰時
Low Power中に操作が行われた場合は、「Low Powerからの復帰時」に従う。

-   SMH Media Popupでは以下を表示する。  
    \[用紙サイズ\]  
    ▼CDI系 M/Cでは用紙ガイド幅に応じた定形サイズ。  
         CDI系M/Cで表示する定形サイズは、用紙ガイド幅の変更によりリアルタイムに表示も更新する。  
        <詳細>  
         ①SMH Media
    Popupを開くタイミングで、ガイド幅取得のためポーリング開始の旨IOTscへ通知する。  
         ②一定周期ポーリングでガイド幅に応じたサイズがmmでUIへ通知される。  
         ③UIは、以下の表に示す判断でSMH用紙サイズボタンを選択状態にする。

    -   DMP6-3まで :
        通知されたガイド位置に合わせて、自動的にサイズを変更する。

    -   DMP2007-1以降 :
        ガイド位置(判定結果)の変化が無い場合、自動サイズ変更は実施しない。

|No|判定条件<br/>(Wは検知したガイド幅 mm)<br/>|SMH Media Popup内<br/>自動選択用紙サイズ<br/>|用紙幅(mm)|備考|
|---|---|---|---|---|---|
|1|288mm &lt; W|A3SEF|297|※適合する用紙サイズがない場合、または左記サイズがUIで表示不可なサイズの場合には、"サイズ不定"を表示する。|
|2|268mm &lt; W ≦ 288mm|11×17" SEF|279||
|3|236mm &lt; W ≦ 268mm|B4SEF|257||
|4|213mm &lt; W ≦ 236mm|8.5×14" SEF|216||
|5|196mm &lt; W ≦ 213mm|A4SEF|210||
|6|165mm &lt; W ≦ 196mm|B5SEF|182||
|7|144mm &lt; W ≦ 165mm|A5SEF|148||
|8|134mm &lt; W ≦ 144mm|5.5×8.5" SEF|140||
|9|116mm &lt; W ≦ 134mm|B6SEF|128||
|10|102mm &lt; W ≦ 116mm|A6SEF|105||
|11|98mm &lt; W ≦ 102mm|官製はがき|100||
|12|0 または上記以外*|Unknown|不明||

④\[決定\]押下で、選択用紙サイズをNVMにWriteしてSMH Media
Popupを閉じる。同時にポーリング停止を要求する。  
⑤\[取り消し\]押下では、NVMには選択用紙サイズをWriteせずSMH Media
Popupを閉じる。同時にポーリング停止を要求する。

▼DDI系 M/Cでは最後に設定された用紙サイズ(NVM)  
 
DDI系M/Cでは、用紙ガイド幅の検知ができないため、前回設定済みの用紙サイズNVMを参照し表示する。  
      (CDI系のようにポーリングは、しない)
###### 詳細  
①SMH Media
Popupを開くタイミングで、SMH用紙サイズNVM(DMP5で新規追加システムデータ)を参照し該当サイズを選択状態にしてPopupをOpenする。  
②\[決定\]押下で選択用紙サイズをNVMにWriteしてSMH Media
Popupを閉じる。  
③\[取り消し\]押下では、NVMには選択用紙サイズをWriteせずSMH Media
Popupを閉じる。

-   Print Around対象機種(PDI Lib.)の場合、Tools
    Modeへ遷移せずにシステムデータを更新する。(RF2225)(CH13723が未導入の場合)

       ・  DMP-Yokohama-2c以降は、ジョブ中のSMH設定変更の可否(PDI-Lib)に応じて[決定]押下時の動作が異なる。(CH13723)
ジョブ中のSMH設定変更 禁止:一時的にTools
Mode(ジョブ規制あり)に遷移して、システムデータを更新する。
ジョブ中のSMH設定変更 許可:Tools
Mode遷移はせずに、システムデータを更新する。本PDIが提供されているプロダクトではPrintAround対象か否かに関わらず本PDIの設定に従いToolsMode遷移を制御する。

-   セットした用紙をSMHから抜いても、表示していたSMH Media
    Popupは閉じない。

-   用紙挿入でSMH Media
    Popup画面が表示されている(見えている)状態では、\[スタート\]、\[リセット\]
    は実施できない。それ以外のボタン/キー操作に対する制限はない。

-   画面消去のタイミングは、通常トレイのMediaPopup同一。

-   SMHへの操作を検知した場合MediaPopup中のIOTスケジュール禁止動作としてシステムデータ\[PFRID\_IOT\_INTRAY\_USER\_OPERATION\_STATUS\]のSMHトレイの状態を以下のように制御する(CH17075により導入)。

    -   \[用紙切れ\]検知時、もしくはMediaPopup表示時(※1、※2)、SMHトレイの状態を操作中(1)に設定する。

    -   \[用紙挿入(100%)\]状態且つMediaPopup非表示状態が成立時、SMHトレイの状態を非操作中(0)に設定する。

        -   1用紙挿入時以外のMediaPopup表示条件も含む

        -   2
            MediaPopup表示は節電(LowPower/Sleep)中の表示予約状態を含む。節電復帰後MediaPopup禁止状態の場合、その時点でMediaPopup非表示状態となる。

###### 制限・注意事項/備考

-   用紙サイズの候補は、KOで割り当てられている11種類の用紙サイズ(ガイド幅に合わせたサイズ候補表示はしない)。

-   CDI系の場合、SMH Media
    Popup画面から用紙サイズボタンを選択した場合、ポーリングを中止する要求を通知し自動ガイド幅検知を中止する(これ以降一度SMH
    Media
    Popupを開きなおさない限り、ガイド幅を動かしても自動検知はしない)。

-   UnKnown(サイズ不定)の場合、\[決定\]ボタンを押下できない。

-   SMH Media
    Popupの設定は、あくまでも用紙サイズ/用紙紙質の設定であり、本設定が実施されてもSMHが選択されたことにはならない。SMHをコピーからトレイとして選択する場合は、トレイ選択画面から手動でSMHを選択する必要がある。

-   SMH Media
    Popupがシステムデータ上有効な場合、SMHの用紙サイズ/紙質の設定は、用紙挿入時に表示されるSMH
    Media
    Popupからのみである。結果として「SMHサイズ自動検知」は選択できない。

-   SMH Media
    Popupはあくまでも用紙セット時に表示するので、SMHからのプリント中にScanAheadで異なる用紙サイズ/紙質のジョブをキューイングすることはできない。

-   サブシステムFail等でコピージョブが実施できない場合でも、SMH Media
    Popupは表示する(表示しても意味がないが、サブシステムFail自体レアケースとして問題とはしない)。

-   ジョブメモリ時にSMH Media
    Popup表示のタイミングで登録を中止し対象外とする。

-   その他画面動作に関する詳細は、Dialog仕様書を参照

-   SMH Media Popup 有効/無効システムデータは、PGS1002SGP/PGS2002SGP
    で有効となる。

-   RF706(CH10296)対応による。

-   CH10154は、DMP5以降のMN
    Productが対象として導入したが、特に仕向け地での制限をかけずに提供している(HB/FCW共通でPDIのみ参照)。

-   ジョブ中のSMH設定変更可否のPDI-LibはCH14391にて追加。

-   Print Around対象機種(PDI
    Lib.)の場合、以下のケースでは設定変更を受け付けない。(RF2225)(DMP-Yokohama-2cまで、DMP-Kobe以降は許可)。

    -   結合ジョブがIIT占有中

-   SMHトレイはDedicatedTrayの設定対象外(CH16074)。

###### 参考資料

共通プラットフォームシステム基本仕様書FF編 Copy 3.1.3 SMH Media Popup /
PGS2064SGP 06 検討メモ