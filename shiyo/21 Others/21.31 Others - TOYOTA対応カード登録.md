## TOYOTA対応カード登録

### 要求概要

トヨタ様(CH15493,CH16299)個別PIN入力したデバイスで、

未登録のICカードを
ICカード認証器にかざしたときに、デバイスUI側で登録要求する画面を表示させ必要なユーザ情報を入力して登録要求することにより、そのICカードをユーザ登録させることができる。

### 対象YKと対象プロダクト

- RF3025 CH17758<個別案件>:トヨタ自動車及びトヨタグループ会社対応共通認証セキュリティ要件

\[対象機種\]

- Howl-PL-FX(DMP2008-1PL)

- Tarzan3-PL-FX(DMP2008-1PL)

- Volante3-PL-FX(DMP2008-1PL)

- RF3357 CH17758<個別案件>:トヨタ自動車及びトヨタグループ会社対応共通認証セキュリティ要件(Kisyu対応)

\[対象機種\]

- Kisyu-FX(DMP2009-1)

- RF3458 CH18183個別要求(RF3357:トヨタ)の共通対応-ト認証セキュリティ要件

\[対象機種\]

- DMP2009-2-b以降

### 注意制限事項

1)登録中(認証(ユーザ検索)中,カード登録中,カード登録後の認証処理中)は、割り込みなどのHWキー押下は基本的に禁止させる。

### 前提条件

### 個別PIN

- トヨタ様対応(DMP2008-1PLで導入済みのCH15493,CH16299)個別PINを入力する。

### システムデータ
###### システムデータ

|項目|設定範囲|備考|
|---|---|---|---|
|メールアドレス登録可能フラグ|true,<br/>false<br/>|メールアドレス検索サーバーで検索して取得したメールドレスを修正変更してMF認証サーバーに登録するか、否か、を表す。具体的には<br/>trueの場合、メールアドレス入力画面表示し編集可能でかつ、MF認証サーバーに登録する。<br/>falseの場合、メールアドレス入力画面表示せず(ユーザにメールアドレス変更する許可を与えない)、かつMF認証サーバーに登録する(【注意】BG129280参照)<br/>※PGS1028SGP側で設定可能。UIではNVM Read/Wtriteで設定可能。<br/>|


- 認証方式:  Remote (UI DFD16.5
Tools-認証セキュリティ設定「認証方式の設定」章を参照)

- 集計モード: OFF (UI DFD16.4 Tools-集計管理「認証/集計機能
Mode」章を参照)

- 外部認証システム: LDAP (UI DFD 16.3.07 Tools
-仕様設定「Network認証システムの設定」章を参照)

- IC-Card Gate外部認証連携時のパスワードモード: 使用しない (UI DFD16.5
Tools-認証セキュリティ設定「ICカード連携モード」章を参照)

###### 注意事項

- BG129280よりメールアドレス登録可能フラグ:falseの場合で不正なメールアドレスが通知してくる場合がある。この場合UIでは文法/ドメインチェックは行わずそのままカード登録要求する。

### 環境

- **MF認証サーバー**

カード管理・利用制限を持つサーバで、実際に外部認証を要求するところで、かつICカード情報とメールアドレスを紐付けして登録するサーバー。

IPアドレスなどの事前設定はPGS1028SGP側で実施する。

\\

- **AD認証サーバー1～10**(Kerberosと同様な型で最大10サーバー用意する)

全社ユーザ管理するサーバ。下記の「認証(ユーザー検索)画面」で

-UserID: 1～32バイトの7Bit ASCII

-パスワード: なし、4～12文字の7Bit ASCII

-ドメイン(認証先)

を入力して認証(ユーザー検索)要求するAD認証サーバー。

IPアドレスなどの事前設定はPGS1028SGP側で実施する。

- **メールアドレス検索サーバ1～5**

メールアドレスを持つサーバ。

IPアドレスなどの事前設定はPGS1028SGP側で実施する。

- **ICカードリーダー**を本体に接続する。

 -関連商品接続(850-001):有(1)かつ関連商品の種類(850-007):ICCG(10)をNVM設定してICCG接続する。

or

-USB型ICカードリーダー接続する(詳しくはUI DFD16.5
Tools-認証セキュリティ設定「ICカードの使用」章を参照)。

### カード登録のシーケンス

### 概略

1)ICカードをICカードリーダーにかざし、MF認証サーバーに認証要求する。

2)未登録カードであれば、認証(ユーザー検索)要求画面を表示させ、UserID、パスワードとAD認証サーバーのドメイン(認証先)を入力して、登録済みユーザーであるかどうかをユーザー検索要求する。

3)登録済みユーザーであれば、そのユーザに関連付けされているメールアドレスを取得し、メールアドレス検索サーバに照合させる(NetAuth側で実施する)。

4)メールアドレス検索の結果にかかわらず、システムデータ「メールアドレス登録可能フラグ」がtrueであれば、メールアドレス入力画面を表示させメールアドレスを適宜変更/入力してMF認証サーバーに、カード登録要求する。Falseであればメールアドレス入力画面をスキップしてカード登録中に移行する。

5)カード登録に成功すれば、そのユーザでCO認証済みとなる。登録失敗すれば最初の未認証・関連商品:Disableに戻る。

### 各フェーズ、画面ごとの詳細

上記、概略シーケンス図の各フェーズ、画面毎の詳細を示す。

**●「認証処理中…」**(既存の仕様どおり)

###### 概略

認証成功すれば、そのままCO認証済みになってデバイスが利用可能になる。

「未登録カード」以外の認証失敗の場合は、認証NGである旨をユーザに知らせて未認証(未集計)に戻る。

運用上システムデータIC-Card
Gate外部認証連携時のパスワードモード:使用しないの設定のみのため、パスワード要求画面は表示されない。

###### 例外処理

- 関連商品状態がDisableになったとき、認証処理が取り消される(既存仕様どおり)。

- 別カードかざしすると、取り消し中→取り消し完了→未認証・関連商品:Disable状態になる(既存仕様どおり)。

- Auto Clear禁止。

###### 取り消し操作

\[取り消し\]ボタンを設けて、認証処理を取り消しして最初の状態「未認証・関連商品:Disable」に遷移する。

**●「認証(ユーザ検索)要求画面」**

###### 概略

認証結果が認証NG(「未登録カード」)であったら、トヨタ様(CH15493,16299)個別PINが入力済みであれば、まず「カード登録画面」を表示させ、ユーザーカード登録するかどうかを促す。

ここでユーザーカード登録をしたい場合には、\[ユーザーカード登録\]ボタンを押下することで「認証(ユーザ検索)要求画面」に遷移する。

この画面でAD認証サーバーのドメイン(認証先)、UserID、パスワードを入力してユーザー検索要求する。

※ドメイン(認証先)が正常に取得できなかった場合などは下記「パネルからの認証」章参照。

ユーザ検索成功すれば、続いてカード登録のフェーズに移行する。但し、この時点では認証済み状態にはならない。

ユーザ検索失敗の場合は、検索NGである旨をユーザに知らせて

-   「ユーザー名またはパスワードエラー」のときは、再び「認証(ユーザ検索)要求画面」を表示させる(入力されたものはすべてクリアされる)。

-   上記以外(「サーバーがダウン」など)の検索NGときは、検索NGである旨をユーザに知らせるのみ。これを閉じると最初の状態「未認証・関連商品:Disable」に遷移する。

###### 例外処理

- 関連商品側をDisableとしたとしても、無視してそのままの画面状態にする。

- 別カードかざしすると一旦Disableになり認証処理に行くが、無視してそのままの画面状態にする。

- Auto Clear対象で、Auto
Clear後は最初の状態「未認証・関連商品:Disable」に遷移する。

- HardKey受付有無は、UI Dialogue仕様書\*1を参照。

###### 取り消し操作

\[取り消し\]ボタンを設けて、認証画面を取り消しして最初の状態「未認証・関連商品:Disable」に遷移する。

-   **「ユーザー検索中…」**

###### 概略

AD認証サーバーにユーザー検索中であることをユーザに知らせる。

###### 例外処理

- 関連商品側をDisableとしたとしても、無視してそのままの画面状態にする。

- 別カードかざしすると一旦Disableになり認証処理に行くが、無視してそのままの画面状態にする。
- Auto Clear禁止。
- HardKey受付有無は、UI Dialogue仕様書\*1を参照。

###### 取り消し操作

\[取り消し\]ボタンを設けないで、途中での取り消しは不可とする。

**●「メールアドレス入力画面」**

###### 概略

- システムデータ「メールアドレス登録可能フラグ」がtrueで、上記検索要求がOKとなったUserIDに紐付けされたメールアドレス(空欄のケースもあり)をUI表示させる。

ユーザは適宜修正・入力してカード登録要求する。

カード登録要求の結果がNGであった場合、NGである旨をユーザに知らせる:

-   「メールアドレス指定誤り(ドメイン不一致)」、「メールアドレス文法エラー」の場合は、もう一度メールアドレス入力画面を開き、入力されたメールアドレスが表示される。

-   上記以外(「サーバーがダウン」など)のときは、NGである旨をユーザに知らせるのみ。これを消すと最初の状態「未認証・関連商品:Disable」に遷移する。

- システムデータ「メールアドレス登録可能フラグ」がfalseの場合、「メールアドレス入力画面」は表示されず「ユーザー検索」が成功したら継続して「カード登録中..」へ移行する。

###### 例外処理

- メールアドレス入力が空欄でもカード登録要求できない(【注意】BG129226:メールアドレス入力が空欄のとき「メールアドレス文法エラー」で弾いてしまっているため登録できない)。

- 関連商品側をDisableとしたとしても、無視してそのままの画面状態にする。

- 別カードかざしすると一旦Disableになり認証処理に行くが、無視してそのままの画面状態にする。
- Auto Clear対象で、Auto
Clear後は最初の状態「未認証・関連商品:Disable」に遷移する。
- HardKey受付有無は、UI Dialogue仕様書\*1を参照。

###### 取り消し操作

\[取り消し\]ボタンを設けて、メールアドレス入力画面を取り消しして、最初の状態「未認証・関連商品:Disable」に遷移する。

**●「カード登録中…」**

###### 概略

MF認証サーバーにカード登録中であることをユーザに知らせる。

###### 例外処理

- 関連商品側をDisableとしたとしても、無視してそのままの画面状態にする。

- 別カードかざしすると一旦Disableになり認証処理に行くが、無視してそのままの画面状態にする。
- Auto Clear禁止。
- HardKey受付有無は、UI Dialogue仕様書\*1を参照。

###### 取り消し操作

\[取り消し\]ボタンを設けないで、途中での取り消しは不可とする。

**●「登録結果の表示」**

###### 概略

カード登録成功した場合、MF認証サーバーにカード登録成功であることをユーザに知らせて、継続して「登録後の認証処理中…」に移行する。

カード登録失敗した場合、MF認証サーバーにカード登録失敗であることをユーザに知らせる。これを消すと最初の状態「未認証・関連商品:Disable」に遷移する。

###### 例外処理

- 「登録結果の表示」する以前に、関連商品がDisableになっていたときは、

カード登録成功 or
失敗したであることをユーザに知らせるのみで、「登録後の認証処理中…」に遷移しない。

- 「登録結果の表示」する以前に、別カードかざししていた場合は、

カード登録成功 or
失敗したであることをユーザに知らせるのみで、「登録後の認証処理中…」に遷移しない。

- 「登録結果の表示」のところで、関連商品がDisableになったときは、

カード登録成功した場合は下記「登録後の認証処理中」参照。

カード登録失敗した場合、UI Dialogue Concept and Basic
BehaviorどおりProgram Clearされる。

- 「登録結果の表示」のところで、別カードかざしすると、

カード登録成功した場合は下記「登録後の認証処理中」参照。

カード登録失敗した場合、Disable通知で一旦Program
Clearされて新規の認証処理に行く。
- Auto Clearについて
カード登録成功した場合、継続して「登録後の認証処理中…」に移行するためAuto
Clear禁止。
カード登録失敗した場合、カード登録失敗であることをユーザに知らせる画面表示されるので、その画面がAuto
Clear対象となり、
Auto Clear後は最初の状態「未認証・関連商品:Disable」に遷移する。

- HardKey受付有無は、UI Dialogue仕様書\*1を参照。

###### \[閉じる\]ボタン操作

\[閉じる\] ボタンを設けて、登録結果画面を閉じられる。

i)カード登録成功して「登録後の認証処理中…」に遷移している場合は\[閉じる\]
ボタンは効かないようにする。

ii)上記以外の場合は、\[閉じる\]
ボタン押下すると最初の状態「未認証・関連商品:Disable」に遷移する。

**●「登録後の認証処理中…」**

###### 概略

カード登録成功した場合、そのユーザで認証要求する。

###### 例外処理
- 上記「ユーザー検索中…」、「登録中…」に関連商品状態:Disable通知または、別カードかざされた場合には、登録後の認証要求をしないのでここのフェーズはない。

- 関連商品状態がDisableになったときは、認証中止されて最初の状態「未認証・関連商品:Disable」に遷移する。

- 別カードかざしすると、取り消し中→取り消し完了→未認証・関連商品:Disable状態になる。
- Auto Clear禁止。
- HardKey受付有無は、UI Dialogue仕様書\*1を参照。

###### 取り消し操作

\[取り消し\]ボタンを設けて、認証処理を取り消しして「取り消し(中止)ました」画面を表示させる(タイマーを効かせる)。

その画面を消すと最初の状態「未認証・関連商品:Disable」に遷移する(09/11/24
ダイアログ検討会で決定)。

**●「登録・認証結果の表示」**

###### 概略

カード登録成功かつ認証が成功もしくは失敗した場合、その旨をユーザに知らせる(タイマーは効かせない)。これを消すと最初の状態「未認証・関連商品:Disable」に遷移する。

###### 例外処理

- 関連商品状態がDisableになったとき、認証処理が取り消される(既存仕様どおり)。

- 別カードかざしすると、一旦Disable通知され認証解除されて、新しい認証処理が始まる。

- Auto Clear対象。

- HardKey受付有無は、UI Dialogue仕様書\*1を参照。

### パネルからの認証

カード忘れ時などでパネルから認証する場合には、AD認証サーバーに認証要求をするため、UserID,Password入力の他にAD認証サーバーのドメイン(認証先(レルム))を指定して認証要求する。

認証モード:外部認証で認証プロトコル:LDAPなので注意が必要。

###### 例外処理

-   ドメイン(認証先(レルム))が1個も取得できなかった場合

   「認証先がありません。機械管理者に確認してください。」旨を表示させ認証要求させないようにする。

-   デフォルトのドメイン(認証先(レルム))が取得できなかった場合

   ドメイン(認証先(レルム))が初めは未設定状態になるので改めて認証先を設定しなければならない。