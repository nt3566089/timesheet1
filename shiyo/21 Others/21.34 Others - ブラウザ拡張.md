## ブラウザ拡張

###### 概要
UIは、カスタムサービスやWebアプリケーション連携サービスなどEWBのブラウザを利用するコンテンツにブラウザの拡張機能を提供する。
これらの機能はDeviceカスタマイズを主に目的としているため、カスタマイズへの要求の増加に伴い提供する機能の追加が行われている。
本節では、UIが提供するブラウザ拡張について、記載する。

###### テリトリ/機種依存

-   機種共通

-   テリトリ:共通

### ブラウザからの機能要求の処理

###### 概要
ブラウザからの要求は、ブラウザタスクから直接UIの機能が呼び出されることで処理が行われるが、その内容に応じ以下の様な処理方法となる。

|対象となる処理|処理種別|処理方法|結果の返却|
|---|---|---|---|---|
|UI内部情報にアクセスしないもの|即時|要求は呼び出したブラウザタスクで処理される。|◎|
|UI内部情報にアクセスし、<br/>結果を必要とするもの<br/>|同期|要求はQueueに積まれ、UIタスクで処理される。<br/>ブラウザタスクはUIタスクの処理が完了するまで待たされる。<br/>|◎|
|UI内部情報にアクセスし、<br/>結果を必要としないもの。(※)<br/>|非同期|要求はQueueに積まれ、UIタスクで処理される。<br/>ブラウザタスクはUIタスクの処理完了を待たされない。<br/>|×|

   ※
結果を必要とするが、同期処理ではタスク間のデッドロックのリスクがある処理の場合、非同期で要求を処理し、ブラウザへの通知を用いて結果を返却する。
この機能には大きく以下の様な機能が提供される。

-   画面操作機能

-   UI操作機能

-   Browser操作機能

-   Device情報取得機能

  各詳細については後述する。

#### 画面操作機能

###### 概要

-   画面操作機能はブラウザにNativeUIで実現している画面制御の一部を提供する。これらはブラウザからの指示に基づき実行され、NativeUIの画面上に反映される。提供するものを以下に列挙する。

    -   オートクリア

    -   サービス切り替え

    -   PrintUtility画面の呼び出し

    -   外部サービスのクローズ

    -   NativeUIの画面呼び出し(RF4176で追加)

###### 制限・注意事項/備考

-   UIで要求を受け付けた状況によっては実行されずに失敗することがある。その場合にはNGがEWBへと渡される。

##### オートクリア

###### 概要

-   ブラウザにユーザーからのAutoClear実行指示を提供する。

###### 実行条件

-   実行指示を受け付けた時点から実行時までの間に要求元であるブラウザが消滅していないこと。

-   実行指示受付時、Tools・DiagModeにEntryしていないこと。

###### 実行動作

-   通常のDeviceUIのAutoClear動作に順ずる。この際、AutoClear要因としてはその他要因となる。(CE-Exit,認証解除などに伴うAutoClearと同等)

###### 制限・注意事項/備考

-   UIで要求を受け付けた状況によっては実行されずに失敗することがある。その場合にはNGがEWBへと渡される。

###### 制限・注意事項/備考

-   ブラウザ指示からDeviceUI側で実際に動作が実行されるまでの期間はDeviceUI側のキー操作は受け付けられる。そのキー入力が原因で要求元ブラウザが消滅した場合にはAutoClearは実行されない。

-   強制的にかけるAutoClearであるため、Timerに拠るリセット動作とはことなり、AutoResumeやジョブ自動解除は伴わない。

-   実行後ユーザー非操作状態となる。

-   AutoClearTimer禁止としている場合にもAutoClear実行指示は禁止されない。

-   BG114378対応/CH15930対応によりDMP2009-1より導入。

##### サービス切り替え

###### 概要

-   ブラウザからDeviceで利用可能なサービスの移動を提供する。この際、移動先のサービスが認証/集計を要求する場合には認証/集計処理を先に行うよう制御する。

###### 実行条件

-   とくになし

###### 実行動作

-   指定されたサービスがSelectionで提供されていて、かつReady(※)である場合、サービス切り替えを実施する。この際、サービス切り替えに伴う画面再表示が行われる。
※ サービス状態として初期化中もReadyと同等と見なす。

###### 制限・注意事項/備考

-   CH15930対応によりDMP2009-1より導入。

-   移動対象サービスが認証/集計が必要な場合に表示される認証/集計要求画面から取消しを行った場合にはMenuへと遷移する(DMP2009-1)。

-   PrintUtility呼び出し中のPrivatePrintについては本機能でも呼び出し可能(CH17851)。

##### PrintUtility呼び出し

###### 概要

-   ブラウザからPrintUtility機能の呼び出しを提供する。

###### 実行条件

-   指定されたPrint種別が有効であること。

###### 実行動作

-   指定されたPrint種別が有効である場合、PrintUtility呼び出しを行う。この際、認証タイミングが指定されている場合にはその指定に従い認証が要求される。

###### 制限・注意事項/備考

-   CH17851対応によりDMP2009-1(メンテ)で導入。

-   PrivatePrintのみ対応(DMP2009-1～DMP2009-3a)

##### ブラウザで提供する特殊画面のクローズ

###### 概要

-   ブラウザで提供する特殊画面を閉じる操作を提供する。

###### 実行条件

-   指定された画面が存在していること。

###### 実行動作

-   指定された画面(未指定の場合はブラウザで提供する全ての特殊画面を対象とする)が存在する場合、画面のClose操作を実施する。

###### 制限・注意事項/備考

-   CH16680,CH16681対応によりDMP2009-1で導入。

-   指定された画面種別が認証の場合、未認証で表示できる画面が存在しない場合には認証するまでクローズ指示は遅延される。

-   サービスとして提供されるカスタムサービス/外部アクセス/PGS1092SGPは対象としない。

##### NativeUI画面の呼び出し

###### 概要

-   ブラウザからNativeUI画面を呼び出す機能を提供する。

###### 実行条件

-   ブラウザがフォアグランド表示されていること。

-   要求受付から実行までに画面が変更されていないこと。

###### 実行動作

-   ブラウザの上に重ねる形で指定したNativeUI画面を表示する。

###### 制限・注意事項/備考

-   CH19483(CH19537)によりDMP2009-2b(FXメンテ)、DMP2009-3a以降導入。

-   言語切り替えのみ対応(RF4176,CH19483,DMP2009-2b以降)

#### UI操作機能

###### 概要

-   UI操作機能はブラウザにNativeUIで実現しているUI全般の制御の一部を提供する。これらはブラウザからの指示に基づき実行され、NativeUIに反映される。提供するものを以下に列挙する。

    -   オートクリアタイマ禁止

    -   ハードキー入力制限

    -   音声読上げモード変更

    -   ユーザ非操作(非開示)

    -   Run画面表示禁止

    -   Fault画面表示禁止

###### 制限・注意事項/備考

-   UIで要求を受け付けた状況によっては実行されずに失敗することがある。その場合にはNGがEWBへと渡される。

##### オートクリアタイマ禁止

###### 概要

-   外部サービスにオートクリアタイマ禁止状態の操作を提供する。

###### 実行条件

-   とくになし

###### 実行動作

-   ブラウザの指示により自動リセット最大値まで30秒単位でオートクリアタイマを禁止する。

-   既に禁止状態にある場合に再度指示が行われた場合には内部の禁止時間に新たに指示された分を加算する。

-   自動リセット最大値を越えて指示された場合には無視する。

-   キャンセル操作を行った場合には即時禁止は解除される。この際、指定に従いオートクリアタイマをリトリガーする。

-   指定された禁止時間を満了した場合、禁止状態の解除とオートクリアタイマのリトリガーを行う。

###### 制限・注意事項/備考

-   BG114378 対策で、DMP2009-1より導入。

-   禁止状態の場合でもタイマー以外で発生するオートクリアは実行される。

-   何らかの理由によりオートクリアが発生した場合、本禁止状態は破棄される。

##### ハードキー入力制限

###### 概要

-   ブラウザにハードキーの制限を提供する。

###### 実行条件

-   とくになし

###### 実行動作

-   CH15913により、DMP2009-2aから導入。

-   指定された制限種類に応じ、ハードキーの入力制限とオートクリアタイマの禁止を行う。

###### 制限・注意事項/備考

-   オートクリアタイマ禁止状態の場合でもタイマー以外で発生するオートクリアは実行される。

-   何らかの理由によりオートクリアが発生した場合、本禁止状態は破棄される。

-   ブラウザが終了した場合には入力制限は解除される。

##### 音声読上げモード変更

###### 概要

-   ブラウザに音声読上げモード(音声ナビ同等)の制御を提供する。

###### 実行条件

-   とくになし

###### 実行動作

-   指定に従い、音声読上げモードを開始/終了する。

###### 制限・注意事項/備考

-   CH18033により、DMP2009-2b以降導入。

-   ブラウザが終了しても音声読上げモードは終了されない。

##### ユーザー非操作(非開示)

###### 概要

-   ブラウザにユーザー操作を\[非操作\]に変更する手段を提供する。

###### 実行条件

-   とくになし

###### 実行動作

-   ユーザー操作を\[非操作\]に変更する。

###### 制限・注意事項/備考

-   この操作をした場合、外部機器からのアクセスが可能となるため通常コンテンツでの使用は注意すること。

-   DMP2009-2b以降導入。

##### Run画面表示禁止

###### 概要

-   外部サービスにRun画面表示禁止状態の操作を提供する。

###### 実行条件

-   とくになし

###### 実行動作

-   ブラウザの指示によりRun画面表示を禁止する。

-   ブラウザの指示によりRun画面表示を禁止を解除する。

###### 制限・注意事項/備考

-   CH23992 対策で、DMP-XI-1aより導入。

-   Run画面が表示中に本機能が使用されても、Run画面は表示されたままとなり、次のRun画面表示から禁止となる。

-   ジョブ保留時のRun表示は禁止されない。

-   何らかの理由によりオートクリアが発生した場合、本禁止状態は破棄される。

##### Fault画面表示禁止

###### 概要

-   外部サービスにFault画面表示禁止状態の操作を提供する。

###### 実行条件

-   とくになし

###### 実行動作

-   ブラウザの指示によりFault画面表示を禁止する。

-   ブラウザの指示によりFault画面表示を禁止を解除する。

###### 制限・注意事項/備考

-   CH23992 対策で、DMP-XI-1aより導入。

-   Fault画面が表示中に本機能が使用されても、Fault画面は表示されたままとなり、次のFault画面表示から禁止となる。

-   ジョブ異常保留時のRunFaultは禁止されない。

-   何らかの理由によりオートクリアが発生した場合、本禁止状態は破棄される。

##### 利用可能言語の取得

###### 概要

-   言語切替可能な言語の一覧を取得する

###### 実行条件

-   とくになし

###### 実行動作

-   複合機に搭載され、言語切替指示によって切り替えられる言語の一覧を取得する。

-   SystemDataにより禁止とされた言語は一覧に含めない。

###### 制限・注意事項/備考

-   CH38843により、DMP-XI-5(DMP-XI-N-Enh)に導入。

-   FXIBGのROMの場合、通常7言語が搭載されているが、DeviceUIではFXでは2言語に制限して表示している。本機能ではFXテリトリ内でのアジア圏言語切替の個別要求を考慮し、DeviceUI同等の制限は行わない。そのため、一覧では搭載された7言語が返るが、利用側で保証できる範囲で言語を表示させること。

##### 表示言語の切替

###### 概要

-   指定された言語が利用可能な場合、DeviceUIの表示言語を指定言語に切り替える。利用不可能な言語が指示された場合、デフォルト言語となる。

###### 実行条件

-   とくになし

###### 実行動作

-   DeviceUIの表示言語を、指示された言語が利用可能な場合その言語へ、利用不可能な場合にはデフォルト言語とへと切り替える。

###### 制限・注意事項/備考

-   CH38843により、DMP-XI-5(DMP-XI-N-Enh)に導入。

-   本機能ではFXテリトリ内でのアジア圏言語切替の個別要求を考慮し、FXテリトリでの日英2言語の制限等は行わない。そのため、通常DeviceUIでは切り替えられない言語へと切替る事が可能であるが、利用側で保証できる範囲で言語を指示させること。

##### デバイスUIへの復帰

###### 概要

-   呼び出しカスタムサービスが退避制御対象の場合、該当カスタムサービスをUI画面階層上から退避し、直下の画面を復帰する。

###### 実行条件

-   処理を実施する際にTopに出ている画面が退避制御対象の画面であること。

###### 実行動作

-   Top画面が退避制御対象の画面として表示されたカスタムサービスである場合、画面階層上から退避画面Listに該当画面を退避させ、直下の画面を表示する。退避された画面はUI上の退避画面の呼び出し操作で再び呼び出すことが可能。退避Listからの破棄はHomeへのプログラムモード切替時、AutoClear発動時に行われる。

###### 制限・注意事項/備考

-   CH41167、CH41168によりDMP-XIII-1a以降の機種より導入。

-   退避制御対象外の画面がこの操作を行った場合には失敗し、画面制御を行わない。

#### ブラウザ操作機能

###### 概要

-   ブラウザ操作機能はブラウザの表示属性を変更する機能を提供する。提供される機能を以下に列挙する。

    -   表示モードの変更

    -   表示URLの変更

    -   通信エラー発生時の動作指定

###### 制限・注意事項/備考

-   UIで要求を受け付けた状況によっては実行されずに失敗することがある。その場合にはNGがEWBへと渡される。

##### 表示モードの変更

###### 概要

-   ブラウザに表示モードの変更を提供する。

###### 実行条件

-   とくになし

###### 実行動作

-   指定に従い、ブラウザ表示モードを変更する。

###### 制限・注意事項/備考

-   CH17396よりDMP2009-2a以降導入。

-   表示URLの変更と同時に指示可能。

-   表示モードの変更を指示した場合、URLを特に変更しない場合でもサービスの再読込みが行われる。

##### 表示URLの変更

###### 概要

-   ブラウザに表示URLの設定を提供する。

###### 実行条件

-   とくになし

###### 実行動作

-   指定に従い、ブラウザに表示するURLを変更する。

-   変更指示後、表示モードを変更された場合には最後に指示されたURLが再度読み込まれる。

###### 制限・注意事項/備考

-   CH17396よりDMP2009-2a以降導入。

-   表示URLの変更と同時に指示可能。

-   表示モードの変更を指示した場合、URLを特に変更しない場合でもサービスの再読込みが行われる。

##### 通信エラー発生時の動作指定

###### 概要

-   ブラウザの通信エラー発生時の動作を指定する。

###### 実行条件

-   とくになし

###### 実行動作

-   指定に従い、通信エラー発生時の動作を制御する。

###### 制限・注意事項/備考

-   CH20184により、DMP2009-2b(2011年X月メンテ)以降導入。

-   ブラウザを提供する画面が終了するまで、ブラウザが終了しても指定動作が継続

##### 自動リセット禁止条件の有効/無効指示

###### 概要

-   デバイスUI上の自動リセット禁止条件を個別に無効化/有効化する。

###### 実行条件

-   とくになし

###### 実行動作

-   指定に従い、デバイスUIの自動リセット禁止条件を有効/無効を切り替える。

###### 制限・注意事項/備考

-   CH23251により、DMP-X-PL2(IGA-FO)より導入。

-   ブラウザ終了時に指示は効力を失い、無効化された条件は有効状態に戻される。

#### Device情報取得機能

###### 概要

-   Device情報取得機能はブラウザにDeviceの一部の情報取得機能を提供する。この機能で取得できる状態を以下に列挙する。

    -   サービス状態

    -   ChainLink値(数値型のもののみ)

###### 制限・注意事項/備考

-   UIで要求を受け付けた状況によっては実行されずに失敗することがある。その場合にはNGがEWBへと渡される。

##### サービス状態の取得

###### 概要

-   ブラウザから切り替え可能なサービスの状態取得を行う機能を提供する。

###### 実行条件

-   とくになし

###### 実行動作

-   指定されたサービスがSelectionの状態、サービス状態から利用可能かを判断し返す。

###### 制限・注意事項/備考

-   UI内部情報を参照するため、呼び出しタスクはFcwタスクでの処理終了を待たされる。

-   CH15930によりDMP2009-1以降導入。正式対応はDMP2009-2b以降。

##### ChainLink値の取得

###### 概要

-   ブラウザからChainLink値の取得を行う機能を提供する。

###### 実行条件

-   とくになし

###### 実行動作

-   指定されたChainLinkを読み出し、JSON形式で結果を返す。

###### 制限・注意事項/備考

-   数値形式のみサポート(DMP2009-2bから)

-   即時実行形式で行われるため、FCWタスクには影響しない。

-   ChainLink値の取得はChainLinkLibの仕様に基づき取得できるか否かが決定される。

-   DMP2009-2b以降導入。

### ブラウザへのEvent通知

###### 概要
ブラウザへのEvent通知は、ブラウザにFxSystemEventを通知することが出来る。
Eventの種類としては大きく以下の様に分類される。

-   Device情報のEvent通知

-   機能処理結果のEvent通知
各Eventの詳細については後述する。

###### 制限・注意事項/備考

-   CH19217によりDMP2009-2b(メンテ)、CH19218によりDMP2009-3a以降導入。

-   通知対象のEventが発生してもブラウザが存在しない場合には処理せず無視する。

-   Event通知はDMP2009-2b以降のFX/IBGテリトリのみ提供される。

-   JRMのEvent通知をUIが実施するのは暫定対応とし将来的には専用モジュールに移管する(時期はTBD)。

-   画面操作結果EventについてはNativeUI画面の呼び出し指示のみ対応。

#### Device情報のEvent通知

###### 概要

-   Device状態のEvent通知は、DeviceのEventをブラウザにFxSystemEventとして通知することが出来る。ブラウザ上のコンテンツではDeviceの状態に応じて動作を制御する場合にはPollingではなく、この通知をHandlingすることでリアルタイムな制御が可能となる。通知されるDevice情報のEventは以下の通りである。

    -   JRM-認証状態Event

    -   JRM-集計状態Event

    -   JRM-Accessory状態Event(AAA)

###### 制限・注意事項/備考

-   JRMのEvent通知をUIが実施するのは暫定対応とし将来的には専用モジュールに移管する(時期はTBD)。

-   通知内容はJRMからの通知に依存しするため、Eventとして定義される全てのプロパティが通知されることをUIでは保証するものではない。

##### JRM認証状態Event

###### 概要

-   ブラウザにJRMの認証状態Event(IJrmAAAServiceAuthenticationStateEvent)をFxSystemEventとして通知する。

###### 実行条件

-   とくになし

###### 実行動作

-   認証状態EventをI/F表に定義された形式に変換し、JSON形式でFxSystemEventとして通知する。

###### 制限・注意事項/備考

##### JRM集計状態Event

###### 概要

-   JRMの集計状態Event(IJrmAAAServiceAccountingStateEvent)をブラウザにFxSystemEventとして通知する。

###### 実行条件

-   とくになし

###### 実行動作

-   集計状態EventをI/F表に定義された形式に変換し、JSON形式でFxSystemEventとして通知する。

###### 制限・注意事項/備考

##### JRM Accessory状態Event

###### 概要

-   JRMのAccessory状態Event(IJrmAAAServiceAccountStateEvent)をブラウザにFxSystemEventとして通知する。

###### 実行条件

-   とくになし

###### 実行動作

-   Accessory状態EventをI/F表に定義された形式に変換し、JSON形式でFxSystemEventとして通知する。

###### 制限・注意事項/備考

#### 機能処理結果Event通知

###### 概要
機能処理結果Event通知は、ブラウザから要求された機能の結果を通知するEventである。
冗長な処理を要する機能に対し結果を通知することを目的とする。
以下にこれに該当するEventを記述する。

-   画面操作結果Event

###### 制限・注意事項/備考

-   ブラウザが存在しない場合には通知されない。

##### 画面操作結果Event

###### 概要

-   ブラウザからの画面操作要求の結果をブラウザにFxSystemEventとして通知する。

###### 実行条件

-   とくになし

###### 実行動作

-   ブラウザからの画面操作要求の実行結果をJSON形式でFxSystemEvenとしてt通知する。

###### 制限・注意事項/備考

-   CH19483によりDMP2009-2b(メンテ)、CH19537によりDMP2009-3a以降導入。

-   NativeUI画面の呼び出しのみ対応(DMP2009-2b)。