# Webアプリケーション連携

本章では、Webアプリケーション連携について記述する。

## Overview

### Webアプリケーション連携とは

Webアプリケーション連携とは、デバイスが有するDTサービスとデバイス外部に実現される外部サービスを連携させるドキュメントソリューションを提供するサービス形態の一種で、以下の特徴を持つものである。

-   Webアプリケーション連携のUIは、外部サービスを提供するサーバー上にHTMLベースのWebアプリケーションとして実装され、デバイスUIが有するWebブラウザを利用して表示する。そして、利用者は、Webアプリケーションによってパラメータ設定から処理開始までをナビゲーションされる。なお、デバイスUIは、Webアプリケーションを呼び出すポータルとしての機能を提供する。

-   Webアプリケーション連携を実現するジョブは、Webアプリケーション画面から外部サービスに対してCGI等の処理開始要求をSubmitすることによって、外部サービス側でその起動処理が実行される。したがって、従来のデバイスDTサービスと異なり、ジョブ起動は外部サービスによって指示されることになる。なお、起動されるジョブについては、後述する。

-   Webアプリケーション連携を提供するサービスは、「Concept and Basic
    > Behavior」で定義されるプログラムモードの一つとして扱い、一部の制約や例外を除いては、従来デバイスUIの枠組みに準拠した振る舞いをする。これにより、デバイスUIとWebアプリケーションの間で一貫性のあるシームレスな操作環境を提供する。また、Webアプリケーションによってデバイス側で起動されるジョブに対するラン画面やWebアプリケーションによって発生するデバイス側での異常に対するフォルト画面等は、デバイスUIに表示制御に従ってデバイスUI画面として表示される。

### Webアプリケーション連携を提供する外部サービス

Webアプリケーション連携を提供する外部サービスは、以下のとおりである。各サービスが提供する機能についてはFF等の仕様書を参照のこと。

1.  PGS0174SGP(with ArcOPL)

### Webアプリケーション連携の動作条件

Webアプリケーション連携は、DMP3以降FCW
UIが搭載される機種に搭載され、以下の条件を満たす場合に動作可能となる。

-   サービス利用に必要なSelection ServiceがActiveである事。

-   サービス利用に必要なサービス(ジョブフローサービス、スキャンサービス、プリントサービス)が利用できること

-   サービス利用に必要なポート,NVMが設定されている事。

-   サービス利用に必要なハードウエア資源のステイタスがREADYである事。

### ユーザーの利用権限

Webアプリケーション連携を利用できるユーザーは、以下の通りである。[1]

|**認証**|**利用できるユーザー**|
|---|---|---|
|なし|未認証者、KO認証者、CE認証者|
|あり(本体認証/ネット認証/リモート認証)|CO認証者、KO認証者,CE認証者|


##  Webアプリケーション連携によって起動されるジョブ

Webアプリケーション連携により起動されるジョブは、以下のとおりである。

### Web-Scan&Uploadジョブ(CH9244)

Webアプリケーション連携でスキャン等のデバイスDTサービスを利用する場合、SESAMiフレームワークを利用したWeb-Scan&Uploadジョブとして実現する。

Web-Scan&Uploadジョブを起動する処理の流れは、以下のとおりである。

1.  Webアプリケーション画面から外部サーバーに対してCGI等の処理開始要求をSubmitする。

2.  Submitされた外部サーバーは、パラメータ設定状態等に基づき指示書を生成し、Submitのレスポンスとして生成した指示書を返信する。

3.  指示書を受信したデバイスUIは、その指示書をデバイス内部に格納する。

4.  ③によって発生する即時実行型指示書(仮称)の受信通知をデバイスUIが受ける。

5.  ④の通知により指定される指示書をもとに設定変更・ジョブ起動する。

なお、ジョブの振る舞いについては、「23.1 Job Flow Service」および「8.
Job」に記載される仕様に従う。

### Web-DirectPrintジョブ(CH9244)

Webアプリケーション連携で外部サーバーからWebアプリケーション画面表示中のデバイスへプリント指示をする場合、Web-DirectPrintジョブとして実現する。

Web-DirectPrintジョブを起動する処理の流れは、以下のとおりである。

1.  Webアプリケーション画面から外部サーバーに対してCGI等の処理開始要求をSubmitする。

2.  Submitされた外部サーバーは、パラメータ設定状況等に基づきWeb-DirectPrintジョブを生成、Submit元のデバイスに対してWeb-DirectPrintジョブを送信する。このとき、外部サーバー内で前処理等が実行されることもある。

3.  Web-DirectPrintジョブとして、デバイスで実行される。

なお、ジョブの振る舞いについては、「8. Job」に記載される仕様に従う。

##  デバイスUIの役割

本節では、Webアプリケーション連携機能を提供する上でのデバイスUIの役割について述べる。

### ブラウザの外部アクセス機能初期化

Webアプリケーション連携のSelection
Serviceがアクティブな場合、デバイス起動時にブラウザの外部アクセス機能を初期化する。その際、以下の情報をブラウザに通知する。そして、これらの情報は、外部サービスに対して通知され、プロダクトやコンフィグレーション等を識別する情報として利用される。

-   SESAMiデバイス指示書言語仕様バージョン

-   プロダクトコード

-   IPアドレス

-   DADFの有無

### ブラウザのシステム設定

外部サーバーに実装されるUIを表示する画面を開く際に、以下の情報をブラウザに対して設定する。

-   正常入力音の音量設定

-   異常入力音の音量設定

-   Webアプリケーションへ通知する情報(通知内容等については3-2-17
    > 認証FF「Webアプリケーションへの情報通知」を参照[CH11197])

### Webアプリケーション連携を提供する外部サーバーの選択・接続

以下の操作によって接続する外部サーバーが確定した場合、外部サーバーに実装されるUIを表示する画面(以降、Webアプリケーション画面とする)を生成し、確定されたURLのWebコンテンツを表示する。ただし、利用権限を有さないユーザーは、接続する外部サーバーを選択することができない。

-   接続先選択画面および接続先確認画面において選択された接続先への接続を指示されたとき。

-   デフォルトURL設定が有効な場合[2]に、メニュー画面でWebアプリケーション連携を提供するサービスを選択したとき。

-   外部アクセスサーバーNが関連付けられている「メニュー画面上のサービスボタン」もしくは「登録Nキー」を選択したとき(CH11769)

### 画面の表示切替え制御

Webアプリケーション連携利用中、デバイスUI画面とWebアプリケーション画面を必要に応じて切り替えることで、シームレスな操作環境を提供する。以下に、画面の表示切替えが発生するケースを示す。なお、Webアプリケーション連携サービス利用中とは、「メニュー画面等でWebアプリケーション連携を提供するサービスを呼び出したとき」から「Webアプリケーションを提供するサービスを終了するとき」までを指し示す。

#### デバイスUI画面からWebアプリケーション画面への表示切替え

1.  ** class="underline">Webアプリケーションに新規接続したとき**
29.3.3節に記述されるケースがこれに該当し、Webアプリケーション画面に外部サービスのエントリー画面を表示する。

1.  ** class="underline">Webアプリケーション画面表示中に自動表示されたラン画面、フォルト画面が非表示もしくは自動消滅したとき**
Webアプリケーション画面表示中に自動表示されたラン画面、フォルト画面が、「閉じる」ボタン押下等によって非表示になったり、ジョブ終了や障害除去等によりラン画面、フォルト画面が自動消滅した場合、Webアプリケーション画面を再表示する。
このとき、Webアプリケーション画面は、ラン画面、フォルト画面が表示される前の状態で再表示される。ただし、SESAMiフレームワークを利用したジョブを実行した場合には、指示書受信時に指定されるURLのWebコンテンツを表示する。

1.  ** class="underline">Webアプリケーション画面表示中に表示されたジョブ確認画面、機械確認画面が非表示になるとき(パスウェイモード切替えを含む)**
Webアプリケーション画面表示中に「ジョブ確認」キーもしくは「機械確認」キーの押下により表示されたジョブ確認画面もしくは機械確認画面が、「閉じる」ボタン押下やパスウェイモード切替え操作によって、パスウェイモードが再び機能設定モードに戻った場合、Webアプリケーション画面を再表示する。
このとき、Webアプリケーション画面は、ジョブ確認画面、機械確認画面が表示される前の状態で再表示される。

1.  ** class="underline">Webアプリケーション画面表示中に表示された認証画面および言語切り替え画面がオートクリア動作を伴わないで非表示になるとき**
Webアプリケーション画面表示中に「認証」キーもしくは言語切り替え機能呼び出しが設定された「ショートカット」キー(PGS1002SGP仕様の場合、「Language」キー)の押下により表示された認証画面もしくは言語切り替え画面が、ボタン押下等によって非表示になる場合、Webアプリケーション画面を再表示する。
このとき、Webアプリケーション画面は、認証画面、言語切り替え画面が表示される前の状態で再表示される。ただし、これらの画面の表示・非表示に際してオートクリア動作を伴う場合には、Webアプリケーション画面は再表示されず、初期表示画面が表示される。オートクリア動作を伴うケースは、以下の通りである。

-   認証状態で「認証」キーが押下された場合

-   言語切り替えが実行された場合

#### Webアプリケーション画面からデバイスUI画面への表示切替え

1.  **Webアプリケーションを終了するとき(ブラウザの「終了」ボタンを押下したとき)**
ブラウザのステータス領域に配置される「終了」ボタンを押下した場合、Webアプリケーションを終了し、接続先選択画面を表示する。
このとき、後述する終了処理を実行する。

1.  ** class="underline">他のサービス(メニュー、ショートカットキー)を表示するとき**
他サービスへの移動(プログラムモード切替え)が実行される場合、Webアプリケーションを終了する。また、オートクリアタイマーのタイムアップ処理実行時も同様である。
このとき、①と同様に後述する終了処理を実行する。

1.  ** class="underline">ジョブ確認画面および機械確認画面を表示するとき**
「ジョブ確認」キーおよび「機械確認」キーが押下された場合、デバイスUII画面に切り替え、ジョブ確認画面および機械確認画面を表示する。
このとき、Webアプリケーション画面の表示状態は保持され、「閉じる」ボタン押下やパスウェイ切り替え操作によって再び機能設定モードに戻ってきたときに再表示される。

1.  **ラン画面を自動表示するとき**
ラン画面が自動表示される場合には、デバイスUI画面に切り替え、ラン画面を表示する。
このとき、Webアプリケーション画面は、ラン画面が表示される前の状態を保持する。

1.  **フォルト画面を自動表示するとき**
フォルト画面が自動表示される場合には、デバイスUI画面に切り替え、フォルト画面を表示する。
このとき、Webアプリケーション画面は、フォルト画面が表示される前の状態を保持する。

1.  **  
    > 認証画面および言語切り替え画面を表示するとき**
「認証」キーおよび言語切り替え機能が設定された「ショートカット」キー(PGS1002SGP仕様の場合、「Language」キー)を押下された場合、デバイスUI画面に切り替え、認証画面もしくは言語切り替え画面を表示する。

-   このとき、Webアプリケーション画面は認証画面もしくは言語切り替え画面が表示される前の状態を保持する。ただし、これらの画面の表示に際してオートクリア動作を伴う場合には、Webアプリケーション画面を破棄される。オートクリア動作を伴うケースは、以下の通りである。言語切り替えが実行された場合

-   認証状態で「認証」キーが押下された場合(ただし、カードPGS1035SGP使用時は除く)

1.  **オートプログラムクリアが実行される場合**
オートプログラムクリアが実行される場合、Webアプリケーションを終了し接続先選択画面を表示する。このとき、後述する終了処理を実行する。
オートプログラムクリアが実行されるケースは、以下の通りである。

-   カードPGS1035SGP使用時にカードを抜いた場合

### Webアプリケーションが発行する指示書の受信・格納

外部アクセススキャンジョブによってWebアプリケーションのジョブが実現される場合、Webアプリケーション画面から外部サーバーに対して処理開始要求をSubmitした後、外部サーバーはデバイスに対して指示書を返信する。このとき、デバイスUIは、ブラウザを経由してこの指示書を受け取り、デバイス内部に即時実行型指示書として格納する。

なお、指示書受信開始した後、HTTPエラー等の障害が発生した場合やデバイスUIが指示書の格納処理に失敗した場合、デバイスUIがその旨をユーザーに通知し、指示書の受信・格納処理を異常終了する。

### Webアプリケーションが発行した指示書の設定変更・実行

外部サーバーから受信した指示書がデバイス内部に即時実行型指示書として格納されると、その旨がデバイスUIに通知される。そして、その通知を受けたデバイスUIは、指定された指示書に対して設定変更・実行を指示することができる。そして、ジョブ起動処理の結果に応じて、以下の処理を行う。なお、指定された指示書のオープンに失敗した場合は、設定変更・実行処理を異常終了し、ユーザーにその旨を通知する。

###### ジョブ起動成功時

指示書受信時にブラウザから通知されるURLをWebアプリケーション画面に表示する。

**<CH39125(37541)導入以降>Chain-Link
791-107に指定した時間、設定変更画面Closeを遅延することで、URL切替タイミングの調整が可能。CE設定のみ。**

###### ジョブ起動失敗時

利用者にジョブ起動が失敗したことを通知し、ジョブ起動処理を異常終了させる。

なお、指示書の設定変更については、UI-DFD「23.1 Job Flow
Service」に記載される仕様に従う。

### Webアプリケーションによるジョブの状態確認および操作

Webアプリケーションによって実行されるジョブは、通常のデバイスUI同様にラン画面、ジョブ確認画面によって状態確認および操作が可能である。ただし、ラン画面が自動表示されるか否かは、実行されるジョブの種類によって異なる。詳しくは、UI-DFD「8.
Job」を参照のこと。

### Webアプリケーションによるジョブの履歴

Webアプリケーションによって実行されたジョブの実行結果は、Web-Scan&Uploadジョブ、Web-DirectPrintジョブとして他のジョブと識別可能なジョブとしてジョブログに記録され、ジョブ履歴画面やジョブ履歴レポートによって確認可能である。

### Webアプリケーションの終了処理

Webアプリケーションを終了するときの処理として、以下のことを実施する。

-   Webアプリケーション画面の破棄…外部サーバで実装されるUIを表示するウィンドウ等を破棄する。

-   指示書の削除…一時格納した指示書が残存している場合やオープンしている指示書には、削除する。

### システム設定データの登録・変更

Webアプリケーションを利用するために必要なシステム設定データの登録・変更手段をデバイスUIのTools画面で提供し、KOによる設定が可能である。システム設定の項目としては、以下のものがある。

-   (CH09259によりDrop)

-   Webアプリケーション連携を提供する外部サーバの設定(Webアプリケーションとの認証連携設定を含む[CH11197])

システムデータの詳細(設定項目等)については、UI-DFD「16.
Tools」を参照のこと。

### Webアプリケーションとの認証連携(CH11197/CH14968)

WebアプリケーションからBasic認証を要求された際に、システムデータ設定に従い、Webアプリケーションへの認証操作を補助する機能を提供する(3-2-17
認証FF「Webアプリケーションとの接続」を参照)。

CH14968(DMP-Kobe以降導入)の対応により、認証方式はNTLM/Digest/Basicの方式に対応する。いずれの方式を使用するかはWEBサーバー側で自動選択し、Deviceではサーバー側から要求された方式で認証を行う。

システムデータの詳細については、UI-DFD「16. Tools」を参照のこと。

### ブラウザへの機能コード設定(CH23594)

Webアプリケーション連携サービスとしてブラウザを起動する際に、Webアプリケーション毎にシステムデータ設定された機能コード値をブラウザに設定する。この機能コード値によって、ブラウザの振る舞いをカスタマイズすることができる。

ただし、機能コードは、「ブラウザのバージョンによっては参照されないこと」がある。

機能コードに関する詳細は、EWB外部仕様書を参照のこと。

システムデータ設定の詳細については、UI-DFD「16.Tools」を参照のこと。

##  Webアプリケーション連携サービス利用中のデバイスUIの振る舞い

本節では、Webアプリケーション連携サービス利用中のデバイスUIの振る舞いについて、従来デバイスUIに対する制約事項や例外事項を記述する。

### ハードキー

Webアプリケーション連携サービス利用中のハードキーの振る舞いは、以下のとおりである。

-   ブラウザが提供する仮想キーボード使用時に限り、Webアプリケーション画面に対して、以下のキーを提供する。この際、テンキーの制御(入力音を含む)は、、ブラウザが行う。

    -   テンキー(0～9)

-   Webアプリケーション画面表示中に有効となるハードキーは以下のとおりであり、それぞれ従来デバイスUIのホットキーとして機能する。なお、ホットキーとしての振る舞いは、「Concept
    > and Basic Behavior」に定義される。

    -   「ジョブ確認」キー

    -   「機械確認」キー

    -   「メニュー」キー

    -   「ストップ」キー

    -   「認証」キー

    -   「ショートカット」キー

-   上記ホットキー以外のハードキーは、Webアプリケーション画面表示中、受付禁止とする。

-   指示書受信中は、「ストップ」キーのみを有効とする。

-   「指示書の設定変更・実行」画面では、上記ホットキーと「スタート」キーを受付可能とする。

### タイマー

「14.Timer」に記載されるタイマーについて、Webアプリケーション連携に関する条件として以下の項目を追加する。

1.  **オートクリアタイマー**
オートクリア禁止条件に、「EWBが外部サイトにアクセス中。(HTMLおよび画像ファイルを取得中。)」を追加し、合致した場合タイマーを再セットする。

### 割り込み

「21.06 Others -
割り込み」で定義される割り込みの条件に対して、Webアプリケーション連携に関する以下の条件を追加する。

-   割り込み中(割り込み予約中、割り込み解除し予約中を含む)は、Webアプリケーション連携の利用を不可とする。

-   Webアプリケーション連携サービス利用中は、割り込み禁止とする。

### 認証・アカウンティング

デバイスが有する認証機能やアカウンティング機能は、デバイス側の設定に従い動作する。また、Webアプリケーション側で必要とされる認証等は、デバイス側とは独立して動作する。ただし、「29.3.11
Webアプリケーションへの認証連携」により、デバイス側のシステム設定や認証情報を用いてWebアプリケーションに対する認証操作を補助する認証連携機能を提供する(CH11197)。なお、Webアプリケーション連携の利用権限については、29.1.4節に記載されるとおりであり、ジョブ実行に際してはデバイス側での認証やアカウンティングによる制約を受けることもある。

### ジョブメモリ

Webアプリケーション連携を提供するサービスに対する操作(サービスの呼び出しを含む)は、ジョブメモリの記録対象外とする。

[1] この利用権限は、指示書のアクセス権限に基づいている。理由は、認証あり時に未認証状態で指示書を作成すると実行できないケースがあるためである。

[2] デフォルトURLの設定がされていても、対象となる接続先情報にURLが設定されていない場合は、無効とする。DMP6-3以降、デフォルトURLの設定は無効とする(CH11769)