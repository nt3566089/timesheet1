# カスタムサービス

本章では、カスタムサービス機能において、デバイスUIが提供する機能仕様について記述する。

## 概要

本節では、カスタムサービス機能の概要を示す。詳しくは、Common FF「3-2-33
カスタムサービス管理機能」を参照。

### カスタムサービス

カスタムサービスは、デバイス内に登録されたカスタムサービススクリプトを、予め仕様設定された呼び出し方法によって呼び出し、ブラウザ上で実行することで提供されるサービスである。

カスタムサービススクリプトは、ブラウザ上で動作するXML文書の操作が可能なソフトウェアによって実現されるもので、SESAMiインタフェース等によってデバイスから提供される各種サービスを利用することで、デバイスとのインタラクションが可能である。たとえば、Service
Management
I/Fによるデバイス情報の交換や指示書によるジョブの実行が可能である(詳しくは、外部仕様書「カスタム・サービス・スクリプト」を参照)。

なお、カスタムサービススクリプトは、外部機器において作成・修正され、ネットワークを介してデバイスに対する転送・更新・削除が行われる。そして、デバイスに対して利用登録することでデバイス内でサービスとして利用可能となる。また、デバイス登録時に属性を設定することで、その属性に応じた条件でポップアップする画面として利用可能となる。

### カスタムサービスの有効条件

カスタムサービスを利用するにはCommon FF「3-2-33
カスタム・サービス管理機能」に規定される「カスタム・サービス管理機能の利用条件」を満たす必要がある。そして、利用条件が満たされる場合には、カスタムサービス機能のセレクションサービスがアクティブとなり、デバイスUIはカスタムサービス関連機能を有効とする。

### デバイスUIの役割

カスタムサービスに関してデバイスUIが担う役割は、以下のとおりである。

-   **カスタムサービスの利用設定**
カスタムサービスの呼び出し方法に関する仕様設定手段を提供する。具体的な手段については、Common
FF「3-2-33 カスタムサービス管理機能」を参照。

-   ** class="underline">カスタムサービスの属性・表示リソースの利用**
カスタムサービスの利用登録時に設定可能である各種属性に従い、メニュー画面等の表示処理を行う。詳しくは、後述する。

-   **カスタムサービスの呼び出し**
仕様設定に従い、カスタムサービスを呼び出す手段を提供する。具体的な手段については、Common
FF「3-2-33 カスタムサービス管理機能」を参照。

-   ** class="underline">カスタムサービス実行中のデバイスUI動作制御**
カスタムサービス実行時に、必要に応じてカスタムサービス特有のUI動作制御を実施する。詳しくは、後述する。

-   ** class="underline">カスタムサービス画面の属性によるUI動作制御**
カスタムサービスのポップアップ実行時に、必要に応じてポップアップ属性特有のUI動作制御を実施する。詳しくは後述する。

## カスタムサービスの属性・表示リソースの利用

デバイスUIは、カスタムサービスの利用登録時に設定可能であるカスタムサービスの性質等を示す属性やアイコン画像等の表示リソースのロケーションを参照し、取得した情報に基づきメニュー画面等の表示処理を行う。以下、利用登録情報の項目別に取得情報の用途を示す。なお、表示仕様の詳細については、ダイアログ仕様を参照のこと。

-   **SmallIconUrl**
設定されたURLを参照し、取得できたデータが小アイコン画像の仕様を満たす場合、そのリソースを以下のように利用する。

-   メニュー画面のサービスボタンのアイコンに利用する。

-   仕様設定画面でカスタムサービスを識別するためのフィードバック表示に利用する


-   **DescriptionUrl**
設定されたURLを参照し、取得できたデータがカスタムサービススクリプト情報の仕様を満たす場合、そのリソースを以下のように利用する。

-   IconLabel属性をメニュー画面のサービスボタンのラベルに利用する。

-   仕様設定画面でカスタムサービスを識別するためのフィードバック表示に利用する


-   ** class="underline">StartTiming(DMP2009-1以降、CH16680,CH16681により導入)**
設定された値を参照し、ポップアップ属性として利用する。

-   ** class="underline">ViewCapabirity(DMP-XIII-1a以降、CH40225により導入)**
UIデザイン、パネルの大きさによる表示能力を示す。PFLite
App管理Libにより適切な能力が決定されたものを使用する。

-   ** class="underline">AllowSoftKeypad(DMP-XIII-1a以降、CH40225により導入)**
SoftKeypadを表示するかを決定する。PFLite
App管理Libにより適切な能力が決定されたものを使用する。

-   ** class="underline">DisplayMode(DMP2009-1以降、CH16680,CH16681により導入)**
設定された値を参照し、カスタムサービス表示領域属性として利用する。詳細は後述する。

-   **DeviceAuth,
    > VisibleWhenUnauth(DMP2009-2以降、CH17395により導入)**
認証モードOFF以外で設定値を以下のように利用する。

-   DeviceAuthを参照し、TRUEの場合には未認証ユーザーのアクセスを許可しない。またFALSEの場合には集計対象サービス扱いとしない。

-   VisibleWhenUnauthを参照し、FALSEの場合には未認証の場合にはMenu上に表示しない。


-   **AuthUserFrom, AuthUser,
    > AuthUserPasswod(DMP2009-2以降、CH15962により導入)**
外部アクセス同等の機能を提供するためWebServerにアクセスする際に認証を求められた際の認証情報として利用する。

-   ** class="underline">SendAuthInfo(DMP2009-2以降、CH15962により導入)**
外部アクセス同等の機能を提供するためWebServerに認証情報を送信するかを判断するために利用する。

-   ** class="underline">SendAuthorizedRight(DMP2009-2以降、CH15962により導入)**
外部アクセス同等の機能を提供するためWebServerにUser権限情報を送信するかを判断するために利用する。

-   **Function
    > Code(DMP-XI以降、CH24620により導入)**
カスタムサービスとしてブラウザを起動する際にパラメータとして設定する機能コード値である。この機能コード値によって、ブラウザの振る舞いをカスタマイズすることができる。
ただし、機能コードは、「ブラウザのバージョンによっては参照されないこと」がある。

###### 注意/制限事項

-   DMP2007-2aでは、Common FF「3-2-33
    > カスタム・サービス管理機能」に記載されるLargeIconUrl、カスタムサービススクリプト情報のDescription属性の用途に言及しない。

-   DMP2007-2aでは、Common FF「3-2-33
    > カスタム・サービス管理機能」に記載されるIsDisabled、IsNative、Provides情報は利用しない。

## カスタムサービス実行中のデバイスUI動作制御

本節では、カスタムサービス実行中のデバイスUIの振る舞いについて、従来デバイスUI仕様に対する制約および差異を中心に記述する。

### カスタムサービス表示領域

###### DMP-Kobeまでカスタムサービスの表示領域は、デバイスUIの画面表示領域の内、ステータスメッセージ領域を除いた領域とする(つまり、カスタムサービス実行中もデバイスUIによるステータスメッセージ表示は行なわれる)。

###### DMP2009-1以降カスタムサービス登録時に設定した表示属性により、表示領域は決定される。表示属性はデバイスUIのステータスメッセージ領域の表示有無、Menuバーの表示有無とする。デバイスUIのステータスメッセージ領域表示とMenuバーの表示は同時には指定できない。同時に指定した場合にはMenuバーの表示は無視される。(CH16681)

###### DMP-XIII-1a以降カスタムサービス登録時に設定した「UIデザインとパネルの大きさに対する表示能力」、\[表示属性\]、「仮想キーパッドの有無」と、実際の複合機のUIデザインとパネルの大きさから、最適な表示形式、表示領域を決定する。無効なUIデザインと表示属性の組み合わせは無視される。(CH39060、CH40225)

### ハードキー

カスタムサービス実行中のハードキーの振る舞いは、以下のとおりである。

-   カスタムサービスに対して、以下のキーを提供する。入力音についてはブラウザの制御に従う。

    -   テンキー(0～9,\#,\*,C,-(ポーズ))

    -   「リセット」キー

    -   「スタート」キー

-   Webアプリケーション画面表示中に有効となるハードキーは以下のとおりであり、それぞれ従来デバイスUIのホットキーとして機能する。なお、ホットキーとしての振る舞いは、「Concept
    > and Basic Behavior」に定義される。

    -   「ジョブ確認」キー

    -   「機械確認」キー

    -   「メニュー」キー

    -   「ストップ」キー

    -   「認証」キー

    -   「登録N」キー

    -   「リセット」キー2度押し(MNのみ)<CH14643>

-   上記ホットキー以外のハードキーは、Webアプリケーション画面表示中、受付禁止とする。

###### 注意/制限事項

-   

### 割り込み

「21.06 Others -
割り込み」で定義される割り込みの条件に対して、以下の条件を追加する。

-   割り込み中(割り込み予約中、割り込み解除し予約中を含む)は、カスタムサービスの呼び出しを不可とする。

-   カスタムサービス実行中は、割り込み禁止とする。

-   割り込み中は一部表示属性を無効とする。詳細はAppendix中の個別動作を参照(CH42227)。

### ステップ記憶型ジョブメモリ

カスタムサービスに対する操作(カスタムサービスの呼び出しを含む)は、ステップ記憶型ジョブメモリの記録対象外とする。

### カスタムサービススクリプトの異常

デバイスUIは、カスタムサービススクリプトのブラウザ上での動作について関与しない。したがって、カスタムサービススクリプト内で発生する異常やネットワーク利用で発生する異常についてはブラウザのエラーリカバリーに従うこととなる。

ただし、カスタムサービススクリプト実行が原因となってシステムフェイルが発生した場合については、この限りでない。

### 多言語対応

デバイスUIとしては特にサポートしないので、言語切り替え等によってデバイスの表示言語設定とカスタムサービススクリプトのロケールに差異が生じた場合に、カスタムサービススクリプトが正しく表示されることを保証できない。

ただし、HTTPリクエストヘッダーでの言語情報通知およびJavaScript
APIでの言語情報取得によって、カスタムサービススクリプト(およびWebサーバ)側での多言語対応は可能である(言語情報の詳細は「EWB外部仕様書」の「各国語対応」の記述を参照のこと)。

### 「リセット」キー2度押しの振る舞い(MNのみ)<CH14643>

カスタムサービス画面表示時に、「リセット」キーの2度押し(連打)を検知した場合、初期表示画面へ遷移する。操作時には確認画面が表示され、「遷移する」か「取り消す」かを選択できる。認証中である場合は上記に加え、「認証解除し遷移する」の選択も可能となる。

なお、PGS1318SGP操作により、MachineStatus画面/JobStatus画面を表示している際でも、カスタムサービス画面がバックグラウンドで動作している場合は、上記制御を行う。

###### 注意制限事項

-   「リセット」キー2度押しの成立条件は、HBとFCWで異なる。HBは、「リセット」キーが続けて2度押下された場合に2度押しと判断する。FCWは、「リセット」キーが押下されてから7秒以内に再度「リセット」キーが押下された場合に2度押しと判断する(この間
    > タッチパネルへの押下が入った場合、2度押しの判断に含まない)。

###### 参考資料

-   UI-DFD「21.13 Clear All」

### カスタム・サービスへアクセス不可時の制御<CH15961>

カスタム･サービス起動時に、カスタム･サービスのアクセス先への接続および通信が正常に行われない場合、カスタム･サービスのアクセス先に正常にアクセスできない旨をUI画面に表示し、リトライもしくはKO認証画面への遷移を行わせる。

##  表示属性を持つカスタムサービスのデバイスUI動作制御

CH16680,CH16681により、カスタムサービスをサービスではなくポップアップとして表示する機能が導入された(DMP2009-1以降)。

本節では、カスタムサービスをポップアップ表示させる属性とポップアップ表示されたカスタムサービス実行中のデバイスUIの動作制御について記述する。

### カスタムサービスの属性による表示条件

以下の全ての条件が満たされた時、該当するカスタムサービスは指定した属性の条件に従い表示される。

-   カスタムサービスが利用可能であること。

-   システムデータ\[カスタムサービスの属性利用禁止\]に対象として設定されていないこと。

-   デバイスの設定に対し、有効な表示属性が指定されたカスタムサービスが登録されていること。

### 標準的なカスタムサービスポップアップ画面のデバイスUI動作制御

[カスタムサービスポップアップ画面の表示条件](#カスタムサービスの属性による表示条件)によってポップアップ表示されたカスタムサービスは、その表示中にデバイスUIのいかなる操作も抑制しない。そのためホットキーの操作を制限することは出来ない(DMP2009-1)。

ポップアップ表示中のカスタムサービスは任意の操作や自動リセットなどによりその画面が画面階層から削除されるタイミングで閉じられ、ポップアップ画面表示条件を再度満たさない限り、ポップアップされることは無い。

    DMP-XI-3a以降、複数の条件により、自動でキー制限が発生する場合がある。
(詳細はAppendix中の個別動作を参照) <CH29825>

### デバイスUI画面属性でのポップアップ時のデバイスUI動作制御

デバイスUI画面属性を持つカスタムサービスは、従来デバイスUIがポップアップ画面として提供している画面についてのカスタマイズを実現する。例えば認証画面の属性を持つカスタムサービスは、デバイスUIの認証画面が表示される条件でポップアップ表示され、デバイスの認証画面をカスタムサービスで代行することが可能となる。これらの属性を持つ画面はもともとデバイス全体の制御を行うものも含まれるため、重要な役割を持つ画面属性の場合には、デバイスUIとしてその画面に特定の動作制御を提供する。

画面属性による固有の動作制御についてはAppendix(T.B.D)を参照のこと。

### 外部機器呼び出し画面属性でのサービス表示時のデバイスUI動作制御

外部機器呼び出し画面属性を持つカスタムサービスは、外部機器からの呼び出し指示を受け表示呼び出しが行われる。この際、

従来デバイスUIがポップアップ画面として提供している画面についてのカスタマイズを実現する。例えば認証画面の属性を持つカスタムサービスは、デバイスUIの認証画面が表示される条件でポップアップ表示され、デバイスの認証画面をカスタムサービスで代行することが可能となる。これらの属性を持つ画面はもともとデバイス全体の制御を行うものも含まれるため、重要な役割を持つ画面属性の場合には、デバイスUIとしてその画面に特定の動作制御を提供する。

画面属性による固有の動作制御についてはAppendix(T.B.D)を参照のこと。

### Help属性でポップアップ時のデバイスUI画面制御(DMP-XIII-1a、CH41167,CH41168導入以降)

Help属性を持つカスタムサービスが登録されており、かつConfig\[COML\_CONFIG\_UI\_LINK\_TO\_SMART\_HELP\]がSupportedの場合、Help属性を持つカスタムサービスへのプログラムモード切替か、Help属性のカスタムサービス起動を指示された際に、現在の画面階層上にHelp属性のカスタムサービスをポップアップ表示する。この際、既に作成され退避中の該当カスタムサービスがある場合には、そちらを再び表示させる。

Help属性のカスタムサービス起動では、引数を指定することが出来、この指定をした場合、QueryStringとして、カスタムサービスに引数がそのまま渡される。

Help属性のカスタムサービスはClose指示を受けるか、Homeの呼び出し、AutoClearがかかるまでは破棄されず、デバイスUI画面の復帰(returnto)、別プログラムモードへの切替ではカスタムサービスは退避され呼び出し前の状態が維持される。ただし、カスタムサービスの多重度が1のプロダクトの場合には、別のカスタムサービスを呼び出した時点で、ブラウザの状態は失われる。

##  Webアプリケーション連携互換機能の提供

本節では、カスタムサービス実行中の外部アクセス互換機能の利用について説明する。

### Webアプリケーションへの認証情報の通知

CH15962以降、登録時のSendAuthInfo,
SendAuthorizedRight属性を任意の値で指定することにより、Webアプリケーション連携の認証情報通知、権限情報通知と同様の情報をWebアプリケーションへと通知することが出来る。

### Webアプリケーションとの認証連携

CH15962以降、登録時のAuthUserFrom,AuthUser,AuthUserPassword属性を任意の値で指定することにより、Webアプリケーションから認証要求された際に属性に従いWebアプリケーションへの認証操作を捕縄する機能を利用することが出来る。

### 指示書のダウンロード実行

CH15962以降、カスタムサービスはWebアプリケーション連携のジョブ実行方式である指示書のダウンロード実行機能が利用できる(DMP2009-2aより)。

### Exitボタンの利用

CH15962以降、カスタムサービス上に表示されたMenuBarのExitボタンを押下することにより、カスタムサービスを終了しMenuへと遷移する(DMP2009-2aより)。

この動作はPopup表示されているカスタムサービスにも提供される。

### ブラウザ拡張機能の利用

カスタムサービスでは21.36.外部サービス補助機能に記載の機能を利用することが出来る。詳細は21.36章を参照のこと。

##  メニューサービス画面のカスタマイズ

CH19870(DMP2009-2bメンテ)以降、デバイスUIは、以下の条件を満たす場合に、従来のメニュー画面(ネイティブメニュー)に代わり、カスタムサービスをメニューサービス画面として表示する。なお、条件を満たさない場合には、設定によらず、メニューサービス画面としてネイティブメニューを表示する。

-   \[メニューサービスの動作設定\]の設定値が\[カスタムサービス優先\]である

-   Services Home属性を持つカスタムサービスが存在する。

-   割り込み中ではない(DMP-XIII-1a、CH42227導入以降)

## 

## 機種固有仕様

### Production Printerコンパネ搭載機種におけるサービスセレクトボタンの提供(CH25450)

Production Printer向けコンパネ搭載機ではServices
Home画面が提供されない為、カスタムサービスを呼び出す手段として以下の代替手段を提供する。

-   \[システム設定\]画面にカスタムサービス1からNのサービスセレクトボタン領域を用意し、カスタムサービス1～Nを表示可能とする。

-   カスタムサービスの最大登録数はMFP機と同じとする。したがって、インデックスがN+1番以降のカスタムサービスはサービスセレクトボタンによる呼び出しは不可能となる。

###### 機種固有情報

|**機種**|**テリトリ**|**表示可能なカスタムサービスのサービスセレクトボタン数**|
|---|---|---|---|
|DMP-XI-1b<br/>PGS1253SGP<br/>|FX/IBG|7個|
